{% extends 'base.html' %}

{% block title %}Galeri Video - AYZARA{% endblock %}
{% block page_title %}Galeri Video{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form action="{{ url_for('main.videos') }}" method="get" id="searchForm" class="row g-3 align-items-end">
            <!-- Input Method Selection -->
            <div class="col-12">
                <label class="form-label">Metode Pencarian Resi</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="search-method" id="method-manual" value="manual">
                    <label class="btn btn-outline-primary" for="method-manual">
                        <i class="bi bi-keyboard me-2"></i>Ketik Manual
                    </label>

                    <input type="radio" class="btn-check" name="search-method" id="method-scanner" value="scanner">
                    <label class="btn btn-outline-primary" for="method-scanner">
                        <i class="bi bi-upc-scan me-2"></i>Scanner Barcode
                    </label>

                    <input type="radio" class="btn-check" name="search-method" id="method-camera" value="camera"
                        checked>
                    <label class="btn btn-outline-primary" for="method-camera">
                        <i class="bi bi-camera me-2"></i>Deteksi Kamera
                    </label>
                </div>
            </div>
            <div class="col-12 d-none" id="camera-search-section">
                <div class="card bg-dark">
                    <div class="card-body p-0">
                        <div class="position-relative" style="max-height: 250px; background: #000; min-height: 200px;">
                            <!-- Backend Camera Feed -->
                            <img id="camera-search-feed" src="" class="img-fluid w-100"
                                style="display: none; max-height: 250px; object-fit: contain;">

                            <!-- Local Camera Feed -->
                            <div id="local-search-reader-wrapper"
                                class="d-none w-100 h-100 bg-black d-flex justify-content-center align-items-center">
                                <div id="html5-search-reader" style="width: 100%; max-width: 350px;"></div>
                            </div>

                            <div id="camera-search-placeholder"
                                class="d-flex flex-column justify-content-center align-items-center h-100 text-muted p-4"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                <i class="fs-1 mb-2 bi bi-camera text-muted"></i>
                                <h6>Pilih Kamera</h6>
                                <p class="small mb-0">Pilih kamera di bawah untuk mulai scan</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row g-2" id="camera-selector-row">
                            <div class="col-md-8">
                                <select id="camera-search-select" class="form-select">
                                    <option value="">Pilih kamera...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-success w-100" id="btn-connect-camera-search"
                                    onclick="connectCameraForSearch()">
                                    <i class="bi bi-play-circle me-2"></i>Hubungkan Kamera
                                </button>
                            </div>
                        </div>
                        <div class="row g-2 mt-2 d-none" id="camera-scanning-controls"
                            style="position: relative; z-index: 1000;">
                            <div class="col-12">
                                <button type="button" class="btn btn-danger w-100" id="btn-cancel-camera-search"
                                    onclick="cancelCameraSearch()">
                                    <i class="bi bi-x-lg me-2"></i>Batal & Tutup Kamera
                                </button>
                            </div>
                        </div>
                        <div id="camera-search-status" class="mt-2 text-center text-muted">
                            Pilih kamera dan klik Hubungkan Kamera
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <label class="form-label">Cari Resi</label>
                <div class="input-group">
                    <input type="text" name="search" class="form-control" value="{{ search }}" id="searchInput"
                        placeholder="Scan/Ketik Resi..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="Clear">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Platform</label>
                <select name="platform" class="form-select">
                    <option value="">Semua</option>
                    {% for key in platforms.keys() %}
                    <option value="{{ key }}" {% if key==current_platform %}selected{% endif %}>{{ key }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Pegawai</label>
                <select name="pegawai" class="form-select">
                    <option value="">Semua</option>
                    {% for p in pegawai_list %}
                    <option value="{{ p }}" {% if p==current_pegawai %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel me-2"></i>Filter
                </button>
            </div>
            <div class="col-md-3">
                <div class="btn-group w-100" role="group">
                    <button type="button" onclick="exportCSV()" class="btn btn-glass" title="Export CSV">
                        <i class="bi bi-filetype-csv"></i>
                    </button>
                    <button type="button" onclick="exportPDF()" class="btn btn-glass" title="Export PDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                    <button type="button" onclick="generateThumbnails()" class="btn btn-glass"
                        title="Regenerate Thumbnails" id="btnGenerateThumbs">
                        <i class="bi bi-images"></i>
                    </button>
                    {% if current_user.role == 'admin' %}
                    <button type="button" class="btn btn-glass text-danger" id="btnManage" onclick="toggleManageMode()"
                        title="Delete Mode">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Action Toolbar (Admin Only) -->
<div id="bulk-action-bar" class="card mb-4 border-danger d-none fixed-toolbar">
    <div class="card-body d-flex justify-content-between align-items-center py-2">
        <div>
            <span class="fw-bold text-danger me-2"><i class="bi bi-check-square-fill"></i> <span
                    id="selected-count">0</span> Video Terpilih</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="selectAll()">Pilih Semua</button>
            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="deselectAll()">Reset</button>
        </div>
        <div>
            <button class="btn btn-danger" onclick="deleteSelectedVideos()">
                <i class="bi bi-trash-fill me-2"></i>Hapus Terpilih
            </button>
            <button class="btn btn-secondary ms-2" onclick="toggleManageMode()">
                Batal
            </button>
        </div>
    </div>
</div>

<style>
    .fixed-toolbar {
        position: fixed;
        top: 64px;
        left: 284px;
        /* 260px sidebar + 24px padding */
        right: 24px;
        z-index: 900;
        background: #0a0a12;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        transition: left 0.3s ease;
    }

    @media (max-width: 992px) {
        .fixed-toolbar {
            left: 24px;
        }
    }

    /* Manage Mode Styles */
    .manage-mode .video-card {
        cursor: pointer;
        position: relative;
        /* Ensure absolute children are positioned relative to card */
    }

    .manage-mode .video-card:hover {
        transform: scale(1.02);
        box-shadow: 0 0 0 2px #dc3545;
    }

    .video-card.selected {
        box-shadow: 0 0 0 3px #dc3545 !important;
        background: rgba(220, 53, 69, 0.05);
    }

    .video-checkbox-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100 !important;
        display: none;
    }

    .manage-mode .video-checkbox-overlay {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }

    .video-checkbox {
        width: 24px;
        height: 24px;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        accent-color: #dc3545;
        /* Ensure standard appearance override if needed */
        margin: 0;
    }
</style>

<!-- Video Grid -->
<div class="video-grid mb-4">
    {% for rec in recordings %}
    {% set video_path = rec.file_video.replace('\\', '/') if rec.file_video else '' %}
    {% set video_relative = video_path.replace('recordings/', '') if video_path.startswith('recordings') else video_path
    %}
    {% set video_filename = video_path.split('/')[-1] if video_path else '' %}

    <div class="video-card" id="card_{{ rec.id }}" onclick="handleCardClick(event, '{{ rec.id }}', {
            url: '/recordings/{{ video_relative }}',
            resi: '{{ rec.resi }}',
            pegawai: '{{ rec.pegawai }}',
            platform: '{{ rec.platform }}',
            time: '{{ rec.waktu_mulai }}',
            json: '/recordings/{{ video_relative|replace('.mp4', '.json') if video_relative else '' }}',
            file_exists: {{ 'true' if rec.file_exists else 'false' }}
        })">

        <!-- Selection Checkbox Overlay -->
        <div class="video-checkbox-overlay">
            <input type="checkbox" class="video-checkbox" value="{{ rec.id }}" id="chk_{{ rec.id }}"
                onclick="event.stopPropagation(); toggleSelect('{{ rec.id }}')">
        </div>
        <div class="video-thumbnail position-relative">
            <img src="/uploads/thumbnails/{{ rec.thumbnail_name }}" alt="Thumbnail"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                style="width:100%; height:100%; object-fit:cover; {{ 'filter: grayscale(100%); opacity: 0.5;' if not rec.file_exists else '' }}">
            <div class="thumbnail-fallback"
                style="display:none; height:100%; align-items:center; justify-content:center; background:var(--bg-darker);">
                <i class="bi bi-film" style="font-size: 48px; opacity: 0.3;"></i>
            </div>

            {% if not rec.file_exists %}
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center"
                style="background: rgba(0,0,0,0.85); z-index: 5;">
                <i class="bi bi-slash-circle text-danger mb-2" style="font-size: 3rem;"></i>
                <span class="badge bg-danger px-3 py-2">FILE VIDEO HILANG</span>
                <small class="text-muted mt-2">Hanya Metadata Database</small>
            </div>
            {% else %}
            <i class="bi bi-play-circle-fill play-icon"></i>
            {% endif %}
            {% if rec.durasi_detik %}
            <span class="video-duration">{{ rec.durasi_detik }}s</span>
            {% endif %}
        </div>
        <div class="video-info">
            <div class="video-resi"><i class="bi bi-box-seam me-1"></i> {{ rec.resi }}</div>
            <div class="video-meta">
                <span class="badge badge-platform">{{ rec.platform }}</span>
                <span class="ms-2"><i class="bi bi-person me-1"></i> {{ rec.pegawai }}</span>
            </div>
            <div class="video-meta mt-1">
                <i class="bi bi-calendar me-1"></i>{{ rec.waktu_mulai[:16] if rec.waktu_mulai else '-' }}
                {% if rec.file_size_kb and rec.file_size_kb > 1024 %}
                <span class="ms-2"><i class="bi bi-hdd me-1"></i> {{ (rec.file_size_kb / 1024)|round(1) }} MB</span>
                {% elif rec.file_size_kb and rec.file_size_kb > 0 %}
                <span class="ms-2"><i class="bi bi-hdd me-1"></i> {{ rec.file_size_kb }} KB</span>
                {% else %}
                <span class="ms-2 text-warning"><i class="bi bi-exclamation-triangle me-1"></i> 0 KB</span>
                {% endif %}
            </div>
            <!-- Share buttons -->
            <div class="mt-2 d-flex gap-2 align-items-center">
                <div class="btn-group">
                    <button class="btn btn-sm btn-glass"
                        onclick="event.stopPropagation(); shareToSocial('whatsapp', '/recordings/{{ video_filename }}', '{{ rec.resi }}')"
                        title="Share WhatsApp">
                        <i class="bi bi-whatsapp"></i>
                    </button>
                    <button class="btn btn-sm btn-glass"
                        onclick="event.stopPropagation(); shareToSocial('telegram', '/recordings/{{ video_filename }}', '{{ rec.resi }}')"
                        title="Share Telegram">
                        <i class="bi bi-telegram"></i>
                    </button>
                    <button class="btn btn-sm btn-glass"
                        onclick="event.stopPropagation(); shareToSocial('copy', '/recordings/{{ video_filename }}', '{{ rec.resi }}')"
                        title="Copy Link">
                        <i class="bi bi-link-45deg"></i>
                    </button>
                </div>

                {% if current_user.role == 'admin' %}
                <button class="btn btn-sm btn-danger px-2"
                    onclick="event.stopPropagation(); deleteSingleVideo('{{ rec.id }}')" title="Hapus Video">
                    <i class="bi bi-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card text-center p-5">
            <div class="stat-icon mb-3"><i class="bi bi-people"></i></div>
            <h5>Belum ada video</h5>
            <p class="text-muted">Recording video akan muncul di sini</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ pagination.prev_num }}&platform={{ current_platform }}&search={{ search }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}

        {% for page in pagination.iter_pages() %}
        {% if page %}
        <li class="page-item {% if page == pagination.page %}active{% endif %}">
            <a class="page-link" href="?page={{ page }}&platform={{ current_platform }}&search={{ search }}">{{ page
                }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link"
                href="?page={{ pagination.next_num }}&platform={{ current_platform }}&search={{ search }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
<p class="text-center text-muted">
    Menampilkan {{ recordings|length }} dari {{ pagination.total }} video
</p>
{% endif %}

<!-- Enhanced Video Modal -->
<div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-height: 90vh; margin: 5vh auto;">
        <div class="modal-content" style="max-height: 90vh; overflow: hidden;">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalVideoTitle">Pemutar Video</h5>
                    <p class="mb-0 text-muted small" id="modalVideoSubtitle">Detail rekaman</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <!-- Video Column -->
                    <!-- Video Column -->
                    <div class="col-lg-8 bg-black d-flex align-items-center justify-content-center position-relative">
                        <video id="modalVideo" controls class="w-100" style="max-height: 70vh;" autoplay>
                            Your browser does not support the video tag.
                        </video>
                        <!-- Missing File Overlay -->
                        <div id="videoMissingOverlay" class="text-center d-none">
                            <i class="bi bi-slash-circle text-danger mb-3" style="font-size: 4rem;"></i>
                            <h5 class="text-white">FILE VIDEO TIDAK DITEMUKAN</h5>
                            <p class="text-muted">File fisik video telah dihapus atau hilang dari penyimpanan.</p>
                        </div>
                    </div>

                    <!-- Metadata Column -->
                    <div class="col-lg-4 p-4" style="max-height: 70vh; overflow-y: auto;">
                        <h6 class="text-uppercase text-muted mb-3 fw-bold">Informasi Paket</h6>

                        <div class="mb-4">
                            <label class="text-muted small">Nomor Resi</label>
                            <div class="fs-4 font-monospace fw-bold text-break" id="metaResi">-</div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="text-muted small">Platform</label>
                                <div id="metaPlatform" class="badge bg-secondary fs-6">-</div>
                            </div>
                            <div class="col-6">
                                <label class="text-muted small">Pegawai</label>
                                <div class="fw-bold" id="metaPegawai">-</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-muted small">Waktu Rekam</label>
                            <div id="metaTime">-</div>
                        </div>

                        <hr>

                        <h6 class="text-uppercase text-muted mb-3 fw-bold">File Metadata (JSON)</h6>
                        <pre id="metaJson"
                            class="bg-dark text-light p-3 rounded small text-break border border-secondary"
                            style="max-height: 200px; overflow: auto; font-size: 11px; --bs-bg-opacity: .5;">Memuat metadata...</pre>

                        <div class="d-grid gap-2 mt-4">
                            <a id="btnDownloadVideo" href="#" class="btn btn-primary" download>
                                <i class="bi bi-download me-2"></i>Unduh Video
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-generate Thumbnails Notification -->
<div id="thumbGeneratingAlert" class="alert alert-info position-fixed bottom-0 end-0 m-3"
    style="display: none; z-index: 1050;">
    <span class="spinner-border spinner-border-sm me-2"></span>
    Membuat thumbnail...
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='vendor/html5-qrcode/html5-qrcode.min.js') }}"
    type="text/javascript"></script>
<script>
    // Barcode Search Variables
    let searchCameraUrl = '';
    let barcodeSearchInterval = null;
    let isSearching = false;
    let html5SearchQrCode = null; // Local scanner instance

    // Sound effects (same as recording page)
    const sounds = {
        beep: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU='),
        success: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU='),
        error: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU=')
    };

    // Play sound helper
    function playSound(soundName) {
        try {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(e => console.log('Sound play failed:', e));
            }
        } catch (e) {
            console.log('Sound error:', e);
        }
    }

    // Clear search
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchInput').focus();
    }

    // Input Method Handling
    document.addEventListener('DOMContentLoaded', function () {
        const methodRadios = document.querySelectorAll('input[name="search-method"]');
        const cameraSection = document.getElementById('camera-search-section');
        const searchInput = document.getElementById('searchInput');

        methodRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                // Stop any ongoing camera search
                stopCameraSearch();

                if (this.value === 'scanner') {
                    // Scanner mode: auto-focus input
                    cameraSection.classList.add('d-none');
                    searchInput.focus();
                    setupScannerMode();
                } else if (this.value === 'camera') {
                    // Camera mode: show camera section
                    cameraSection.classList.remove('d-none');
                    loadCamerasForSearch();
                } else {
                    // Manual mode
                    cameraSection.classList.add('d-none');
                }
            });
        });

        // TRIGGER INITIAL STATE
        // Find the checked radio and manually trigger the logic
        const checkedRadio = document.querySelector('input[name="search-method"]:checked');
        if (checkedRadio && checkedRadio.value === 'camera') {
            cameraSection.classList.remove('d-none');
            loadCamerasForSearch();
        } else if (checkedRadio && checkedRadio.value === 'scanner') {
            searchInput.focus();
            setupScannerMode();
        }

        // Connect and cancel camera search buttons (now handled via onclick attributes)
        // document.getElementById('btn-connect-camera-search').addEventListener('click', connectCameraForSearch);
        // document.getElementById('btn-cancel-camera-search').addEventListener('click', cancelCameraSearch);
    });

    // Scanner Mode: Auto-focus and submit on Enter
    function setupScannerMode() {
        const input = document.getElementById('searchInput');

        // Auto-focus keep alive
        input.addEventListener('blur', function (e) {
            const method = document.querySelector('input[name="search-method"]:checked');
            if (method && method.value === 'scanner') {
                // Allow interaction with other controls
                if (e.relatedTarget && (
                    e.relatedTarget.tagName === 'BUTTON' ||
                    e.relatedTarget.tagName === 'SELECT' ||
                    e.relatedTarget.tagName === 'INPUT'
                )) {
                    return;
                }
                // Force focus back
                setTimeout(() => {
                    if (document.activeElement !== input) {
                        this.focus();
                    }
                }, 100);
            }
        });

        // Auto-submit on Enter
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (this.value.trim()) {
                    playSound('beep');
                    document.getElementById('searchForm').submit();
                }
            }
        });
    }

    // Load cameras for search
    function loadCamerasForSearch() {
        const select = document.getElementById('camera-search-select');

        // NEW: Handle redirection immediately on selection
        select.onchange = function () {
            if (this.value === '__add_new__') {
                window.location.href = '/camera-settings';
            }
        };

        fetch('/api/cameras')
            .then(res => res.json())
            .then(data => {
                select.innerHTML = '<option value="">Pilih kamera...</option>';

                // Add Local Client Camera option
                const localOption = document.createElement('option');
                localOption.value = 'local_client_device';
                localOption.text = 'üì± Local Camera (Client Device)';
                localOption.style.fontWeight = 'bold';
                select.add(localOption);

                (data.cameras || []).forEach(cam => {
                    const option = document.createElement('option');
                    option.value = cam.url;
                    option.text = `üì∑ ${cam.name}`;
                    select.add(option);
                });

                // Add "Add New Camera" option
                const addOption = document.createElement('option');
                addOption.value = '__add_new__';
                addOption.text = '‚ûï Tambah Kamera Baru...';
                addOption.style.fontWeight = 'bold';
                addOption.style.color = '#0d6efd';
                select.add(addOption);
            })
            .catch(err => console.error('Failed to load cameras:', err));
    }

    // NEW: Connect camera for search (step 1)
    // NEW: Connect camera for search (step 1)
    // NEW: Cleanup on page unload
    window.addEventListener('beforeunload', function () {
        if (searchCameraUrl && searchCameraUrl !== 'local_client_device') {
            const data = JSON.stringify({ url: searchCameraUrl });
            if (navigator.sendBeacon) {
                navigator.sendBeacon('/api/camera/release', new Blob([data], { type: 'application/json' }));
            } else {
                fetch('/api/camera/release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: data
                });
            }
        }
    });

    // NEW: Connect camera for search with Retry Mechanism
    let connectionRetries = 0;
    const MAX_SH_RETRIES = 3;
    let retryTimeout = null;

    function connectCameraForSearch() {
        const select = document.getElementById('camera-search-select');
        const newUrl = select.value;

        if (!newUrl) {
            alert('Pilih kamera terlebih dahulu!');
            return;
        }

        // 1. Release previous camera if different
        if (searchCameraUrl && searchCameraUrl !== newUrl && searchCameraUrl !== 'local_client_device') {
            console.log('>>> [Video Gallery] Switching... Release old:', searchCameraUrl);
            fetch('/api/camera/release', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                keepalive: true,
                body: JSON.stringify({ url: searchCameraUrl })
            }).catch(e => console.log('Old release failed', e));
        }

        searchCameraUrl = newUrl;

        const img = document.getElementById('camera-search-feed');
        const localWrapper = document.getElementById('local-search-reader-wrapper');
        const placeholder = document.getElementById('camera-search-placeholder');
        const status = document.getElementById('camera-search-status');
        const selectorRow = document.getElementById('camera-selector-row');
        const scanningControls = document.getElementById('camera-scanning-controls');

        // Show scanning controls immediately
        if (selectorRow) selectorRow.classList.add('d-none');
        if (scanningControls) scanningControls.classList.remove('d-none');

        // Hide placeholder Forcefully
        placeholder.classList.add('d-none');
        placeholder.classList.remove('d-flex');
        placeholder.style.setProperty('display', 'none', 'important');

        // --- LOCAL CAMERA LOGIC ---
        if (searchCameraUrl === 'local_client_device') {
            img.style.display = 'none';
            localWrapper.classList.remove('d-none');
            status.innerHTML = '<span class="text-info">üîµ Membuka kamera lokal...</span>';

            // CHECK SECURE CONTEXT
            if (window.isSecureContext === false) {
                alert("‚ö†Ô∏è Peringatan: Browser Anda memblokir akses kamera karena koneksi tidak aman (HTTP). Gunakan HTTPS.");
            }

            html5SearchQrCode = new Html5Qrcode("html5-search-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5SearchQrCode.start({ facingMode: "environment" }, config, handleLocalScanSuccess)
                .then(() => {
                    status.innerHTML = '<span class="text-success">üü¢ Kamera lokal aktif! Scan resi...</span>';
                    isSearching = true;
                })
                .catch(err => {
                    console.log("Local camera error", err);
                    let msg = "Gagal membuka kamera lokal.";
                    if (err?.toString().includes("is not supported")) {
                        msg = "Browser tidak mendukung streaming kamera (pastikan HTTPS).";
                    } else if (err?.name === "NotAllowedError") {
                        msg = "Izin kamera ditolak.";
                    }
                    status.innerHTML = `<span class="text-danger">‚ö†Ô∏è ${msg}</span>`;
                });
            return;
        }

        // --- BACKEND CAMERA LOGIC ---
        localWrapper.classList.add('d-none');
        img.style.display = 'block';

        status.innerHTML = '<span class="text-info">üîµ Mempersiapkan kamera server...</span>';

        connectionRetries = 0;

        // Force release first to ensure clean state
        fetch('/api/camera/release', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: searchCameraUrl })
        }).finally(() => {
            attemptCameraConnection();
        });

        function attemptCameraConnection() {
            status.innerHTML = '<span class="text-info">üîµ Menghubungkan...</span>';

            // [ANTIGRAVITY] Set high FPS for barcode scanning
            fetch('/api/camera/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                keepalive: true,
                body: JSON.stringify({
                    url: searchCameraUrl,
                    mode: 'scan' // 20 FPS for better scanning
                })
            }).catch(e => console.log('Set mode failed', e));

            // Set source with timestamp to prevent caching
            img.src = `/video_feed?url=${encodeURIComponent(searchCameraUrl)}&t=${Date.now()}`;

            // SAFETY TIMEOUT in case browser doesn't fire onerror
            const safetyTimeout = setTimeout(() => {
                if (status.innerHTML.includes('Menghubungkan')) {
                    console.error('>>> [Video Gallery] Connection timeout triggered');
                    img.onerror(); // Manually trigger error handler
                }
            }, 10000);

            img.onload = function () {
                if (!searchCameraUrl) return; // Ignore if cancelled
                clearTimeout(safetyTimeout); // Clear safety
                status.innerHTML = '<span class="text-success">üü¢ Kamera terhubung! Mencari barcode...</span>';
                isSearching = true;
                startBarcodeSearchLoop();
            };

            img.onerror = function () {
                if (!searchCameraUrl) return; // Ignore if cancelled
                clearTimeout(safetyTimeout); // Clear safety
                // IMMEDIATE FAILURE - NO RETRY
                console.error('>>> [Video Gallery] Connection failed immediately');

                status.innerHTML = `
                    <div class="d-flex flex-column gap-2 align-items-center">
                        <span class="text-danger">‚ö†Ô∏è Gagal terhubung ke kamera (Timeout/Error).</span>
                        <button class="btn btn-sm btn-outline-primary" style="max-width: 200px;" onclick="connectCameraForSearch()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Coba Lagi (Reload)
                        </button>
                    </div>
                `;
            };
        }
    }

    function handleLocalScanSuccess(decodedText, decodedResult) {
        if (!isSearching || !decodedText) return;

        console.log('>>> [Search - Local] Barcode detected:', decodedText);
        playSound('beep');

        // Update search input
        const searchInput = document.getElementById('searchInput');
        searchInput.value = decodedText;

        // Visual feedback
        const status = document.getElementById('camera-search-status');
        status.innerHTML = `<span class="text-success">‚úÖ Barcode detected: <strong>${decodedText}</strong></span>`;

        stopCameraSearch();

        setTimeout(() => {
            document.getElementById('searchForm').submit();
        }, 500);
    }

    // NEW: Cancel camera search and reset to initial state
    function cancelCameraSearch() {
        console.log('>>> [Video Gallery] Canceling camera search');

        // Stop local
        if (html5SearchQrCode) {
            html5SearchQrCode.stop().catch(e => console.log('Local stop err', e));
            html5SearchQrCode = null;
        }
        document.getElementById('local-search-reader-wrapper').classList.add('d-none');

        // Stop barcode detection
        if (barcodeSearchInterval) {
            clearTimeout(barcodeSearchInterval);
            barcodeSearchInterval = null;
        }

        // Stop pending retries
        if (retryTimeout) {
            clearTimeout(retryTimeout);
            retryTimeout = null;
        }

        const img = document.getElementById('camera-search-feed');
        if (img) {
            img.src = '';
            img.style.display = 'none';
        }

        const placeholder = document.getElementById('camera-search-placeholder');
        if (placeholder) {
            placeholder.classList.remove('d-none');
            placeholder.classList.add('d-flex');
            placeholder.style.removeProperty('display'); // Reset inline style
        }

        // Show camera selector again, hide cancel button
        const selectorRow = document.getElementById('camera-selector-row');
        const scanningControls = document.getElementById('camera-scanning-controls');
        if (selectorRow) selectorRow.classList.remove('d-none');
        if (scanningControls) scanningControls.classList.add('d-none');

        // Reset status
        const status = document.getElementById('camera-search-status');
        if (status) status.innerHTML = 'Pilih kamera dan klik Hubungkan Kamera';

        isSearching = false;

        // Release camera (ONLY if backend)
        if (searchCameraUrl && searchCameraUrl !== 'local_client_device') {
            fetch('/api/camera/release', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: searchCameraUrl })
            }).catch(e => console.log('Release failed', e));

            searchCameraUrl = '';
        }
    }

    // Stop camera search (called after successful scan)
    function stopCameraSearch() {
        // Stop local
        if (html5SearchQrCode) {
            html5SearchQrCode.stop().then(() => {
                html5SearchQrCode = null;
            }).catch(e => console.log('Local stop err', e));
        }
        const localWrap = document.getElementById('local-search-reader-wrapper');
        if (localWrap) localWrap.classList.add('d-none');

        if (barcodeSearchInterval) {
            clearTimeout(barcodeSearchInterval);
            barcodeSearchInterval = null;
        }

        const img = document.getElementById('camera-search-feed');
        if (img) {
            img.src = '';
            img.style.display = 'none';
        }

        const placeholder = document.getElementById('camera-search-placeholder');
        if (placeholder) {
            placeholder.classList.remove('d-none');
            placeholder.classList.add('d-flex');
            placeholder.style.removeProperty('display');
        }

        // Show camera selector again, hide cancel button
        const selectorRow = document.getElementById('camera-selector-row');
        const scanningControls = document.getElementById('camera-scanning-controls');
        if (selectorRow) selectorRow.classList.remove('d-none');
        if (scanningControls) scanningControls.classList.add('d-none');

        isSearching = false;

        // Release camera (backend only)
        if (searchCameraUrl && searchCameraUrl !== 'local_client_device') {
            fetch('/api/camera/release', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: searchCameraUrl })
            }).catch(e => console.log('Release failed', e));

            searchCameraUrl = '';
        }
    }

    // Barcode detection loop
    function startBarcodeSearchLoop() {
        if (!window.socket || !window.socket.connected) {
            console.warn('Socket not ready, retrying...');
            barcodeSearchInterval = setTimeout(startBarcodeSearchLoop, 500);
            return;
        }

        const socket = window.socket;

        // Listen for barcode results
        socket.off('barcode_result');
        socket.on('barcode_result', (data) => {
            if (!isSearching) return;

            if (data.success && data.found && data.barcodes.length > 0) {
                const barcode = data.barcodes[0].data;
                console.log('>>> [Search] Barcode detected:', barcode);
                playSound('beep');

                // Update search input
                const searchInput = document.getElementById('searchInput');
                searchInput.value = barcode;

                // Visual feedback
                const status = document.getElementById('camera-search-status');
                status.innerHTML = `<span class="text-success">‚úÖ Barcode detected: <strong>${barcode}</strong></span>`;

                // Stop scanning
                stopCameraSearch();

                // Auto-submit form after short delay
                setTimeout(() => {
                    document.getElementById('searchForm').submit();
                }, 500);
            }
        });

        // Detection loop
        const detectBarcode = () => {
            if (!isSearching || !searchCameraUrl) return;

            socket.emit('detect_barcode', { url: searchCameraUrl });
            barcodeSearchInterval = setTimeout(detectBarcode, 1000);
        };

        detectBarcode();
    }

    // Video modal logic moved to static/js/modules/video_player.js

    // Auto-generate thumbnails on page load if there are missing thumbnails
    document.addEventListener('DOMContentLoaded', function () {
        // Check for missing thumbnails by looking at fallback elements that are visible
        setTimeout(() => {
            const fallbacks = document.querySelectorAll('.thumbnail-fallback');
            let missingCount = 0;

            fallbacks.forEach(el => {
                // Check if fallback is visible (meaning thumbnail failed to load)
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.display !== 'none') {
                    missingCount++;
                }
            });

            if (missingCount > 0) {
                console.log('[Thumbnail] Found ' + missingCount + ' missing thumbnails, auto-generating...');
                autoGenerateThumbnails();
            }
        }, 1000); // Wait for images to load/fail
    });

    async function autoGenerateThumbnails() {
        const alert = document.getElementById('thumbGeneratingAlert');
        if (alert) alert.style.display = 'block';

        try {
            const response = await fetch('/api/generate-thumbnails-batch', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.generated > 0) {
                console.log('[Thumbnail] Generated ' + data.generated + ' thumbnails');
                // Reload page to show new thumbnails
                location.reload();
            } else {
                if (alert) alert.style.display = 'none';
            }
        } catch (error) {
            console.error('[Thumbnail] Error:', error);
            if (alert) alert.style.display = 'none';
        }
    }

    // --- MANAGE MODE (ADMIN) ---
    let isManageMode = false;
    let selectedIds = new Set();

    function toggleManageMode() {
        isManageMode = !isManageMode;

        const btn = document.getElementById('btnManage');
        const toolbar = document.getElementById('bulk-action-bar');

        if (isManageMode) {
            document.body.classList.add('manage-mode');
            if (btn) {
                btn.classList.add('active', 'bg-danger', 'text-white');
                btn.classList.remove('text-danger'); // Prevent red-on-red conflict
            }
            if (toolbar) toolbar.classList.remove('d-none');
        } else {
            // CANCEL MODE: Clear selection
            deselectAll(); // Fix: Clear selection on cancel

            document.body.classList.remove('manage-mode');
            if (btn) {
                btn.classList.remove('active', 'bg-danger', 'text-white');
                btn.classList.add('text-danger'); // Restore red text
            }
            if (toolbar) toolbar.classList.add('d-none');
        }
    }

    function handleCardClick(event, id, videoData) {
        if (isManageMode) {
            toggleSelect(id);
        } else {
            openVideoModal(videoData);
        }
    }

    function toggleSelect(id) {
        const checkbox = document.getElementById('chk_' + id);
        const card = document.getElementById('card_' + id);

        if (selectedIds.has(id)) {
            selectedIds.delete(id);
            if (checkbox) checkbox.checked = false;
            if (card) card.classList.remove('selected');
        } else {
            selectedIds.add(id);
            if (checkbox) checkbox.checked = true;
            if (card) card.classList.add('selected');
        }
        updateSelectionUI();
    }

    function selectAll() {
        const checkboxes = document.querySelectorAll('.video-checkbox');
        checkboxes.forEach(chk => {
            const id = chk.value;
            selectedIds.add(id);
            chk.checked = true;
            const card = document.getElementById('card_' + id);
            if (card) card.classList.add('selected');
        });
        updateSelectionUI();
    }

    function deselectAll() {
        selectedIds.clear();
        document.querySelectorAll('.video-checkbox').forEach(chk => chk.checked = false);
        document.querySelectorAll('.video-card').forEach(card => card.classList.remove('selected'));
        updateSelectionUI();
    }

    function updateSelectionUI() {
        const countSpan = document.getElementById('selected-count');
        if (countSpan) countSpan.innerText = selectedIds.size;
    }

    function deleteSelectedVideos() {
        if (selectedIds.size === 0) {
            Swal.fire('Info', 'Pilih video terlebih dahulu', 'info');
            return;
        }

        Swal.fire({
            title: 'Hapus ' + selectedIds.size + ' Video?',
            text: "Video dan data terkait akan dihapus permanen!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                performDelete(Array.from(selectedIds));
            }
        });
    }

    function deleteSingleVideo(id) {
        Swal.fire({
            title: 'Hapus Video Ini?',
            text: "Video akan dihapus permanen!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                performDelete([id]);
            }
        });
    }

    function performDelete(ids) {
        // Show loading
        Swal.fire({
            title: 'Menghapus...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/api/videos/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: ids })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Terhapus!', (data.deleted || 0) + ' video telah dihapus.', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Gagal', data.message || 'Gagal menghapus video.', 'error');
                }
            })
            .catch(err => {
                console.error('Delete error:', err);
                Swal.fire('Error', 'Terjadi kesalahan sistem', 'error');
            });
    }
</script>
<script src="{{ url_for('static', filename='js/modules/video_player.js') }}"></script>
{% endblock %}