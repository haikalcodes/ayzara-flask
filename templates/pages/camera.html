{% extends 'base.html' %}

{% block title %}Ambil Gambar - AYZARA{% endblock %}
{% block page_title %}Ambil Gambar{% endblock %}

{% block content %}

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-camera me-2"></i>Ambil Gambar</h5>
                <div class="d-flex gap-2">
                </div>
            </div>
            <div class="card-body">
                <!-- CONTROLS AREA -->
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8 text-center">
                        <label class="form-label text-muted small">Pilih Kamera</label>
                        <select id="cameraSelect" class="form-select shadow-sm mb-3" onchange="updateCameraInfo()">
                            <option value="" disabled selected>‚è≥ Memuat daftar kamera...</option>
                        </select>
                    </div>
                </div>

                <!-- PREVIEW AREA -->
                <div id="previewContainer" class="text-center p-3 rounded position-relative"
                    style="min-height: 400px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: linear-gradient(135deg, #1a1d29 0%, #2d3142 100%); border: 1px solid rgba(255,255,255,0.1);">
                    <!-- Placeholder / Initial State -->
                    <div id="cameraPlaceholder" class="text-light">
                        <i class="bi bi-camera-video display-1" style="opacity: 0.4; color: #6c757d;"></i>
                        <p class="mt-3 lead text-muted">Pilih kamera lalu klik "Cek Kamera"</p>
                    </div>

                    <!-- Live Stream Image (Hidden initially) -->
                    <img id="liveStream" src="" class="img-fluid d-none"
                        style="max-height: 500px; width: 100%; object-fit: contain;" alt="Live Stream">

                    <!-- Local Video Element (Hidden initially) -->
                    <video id="localVideo" class="img-fluid d-none" autoplay playsinline muted
                        style="max-height: 500px; width: 100%; object-fit: contain;"></video>

                    <!-- Hidden Canvas for Capture -->
                    <canvas id="localCanvas" style="display:none;"></canvas>

                    <!-- Zoom Controls -->
                    <div id="zoomContainer" class="zoom-controls d-none">
                        <button class="zoom-btn" onclick="adjustZoom(0.5)" title="Zoom In">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                            <i class="bi bi-aspect-ratio"></i>
                        </button>
                        <button class="zoom-btn" onclick="adjustZoom(-0.5)" title="Zoom Out">
                            <i class="bi bi-dash-lg"></i>
                        </button>
                    </div>
                    <div id="zoomIndicator" class="zoom-info">Zoom: 1.0x</div>
                </div>

                <!-- ALERT FEEDBACK AREA -->
                <div id="feedbackArea" class="mt-3"></div>

                <!-- ACTION BUTTONS CENTERED -->
                <div class="d-flex justify-content-center mt-3 gap-2">
                    <button id="btnCheck" onclick="checkCamera()" class="btn btn-info text-white px-4 fw-bold" disabled>
                        <i class="bi bi-search me-2"></i>Cek Kamera
                    </button>

                    <!-- RENAMED ACTION onclick=performCapture -->
                    <button id="btnCapture" onclick="performCapture()" class="btn btn-primary px-4 fw-bold d-none">
                        <i class="bi bi-camera me-2"></i>Ambil Gambar
                    </button>

                    <button id="btnReset" onclick="resetUI()" class="btn btn-outline-secondary px-4 d-none">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset
                    </button>
                </div>

                <!-- Status Debug -->
                <div id="captureStatus" class="d-none"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-gear me-2"></i>Info Kamera</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted">Camera URL</td>
                        <td><code class="small" id="info-url">Select a camera...</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Format</td>
                        <td>JPEG</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Folder</td>
                        <td><code>uploads/thumbnails/</code></td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title"><i class="bi bi-lightbulb me-2"></i>Tips</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">üì∑ Capture bisa dilakukan saat recording aktif</li>
                    <li class="mb-2">üíæ Gambar tersimpan otomatis</li>
                    <li class="mb-2">‚¨áÔ∏è Klik Download untuk menyimpan</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Capture Result Modal -->
<!-- REMOVED 'fade' class to debug visibility -->
<div class="modal" id="captureModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content text-white" style="background-color: #2d3142;">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title"><i class="bi bi-camera me-2"></i>Hasil Pengambilan Gambar</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0 bg-dark position-relative">
                <div class="d-flex justify-content-center align-items-center"
                    style="min-height: 300px; background: #000;">
                    <img id="modalCaptureImage" src="" class="img-fluid" style="max-height: 70vh; object-fit: contain;"
                        alt="Captured Frame">
                </div>
            </div>
            <div class="modal-footer border-top border-secondary justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <a id="btnDownloadModal" href="#" download class="btn btn-success">
                    <i class="bi bi-download me-2"></i>Unduh Gambar
                </a>
            </div>
        </div>
    </div>
</div>
<style>
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
        transition: opacity 0.3s;
    }

    .zoom-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .zoom-btn:hover {
        background: rgba(13, 110, 253, 0.6);
        transform: scale(1.1);
    }

    .zoom-btn:active {
        transform: scale(0.9);
    }

    .zoom-info {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        pointer-events: none;
        z-index: 100;
        display: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }
</style>

<script>
    // Global variables
    let selectedCameraUrl = '';
    let healthCheckInterval = null;
    let currentZoom = 1.0;

    // Load cameras when page loads
    document.addEventListener('DOMContentLoaded', function () {
        loadCameras();

        // Save camera selection interaction
        const select = document.getElementById('cameraSelect');
        if (select) {
            select.addEventListener('change', function () {
                if (this.value && !this.value.startsWith('__')) {
                    localStorage.setItem('last_camera_url', this.value);

                    // Enable check button
                    const btnCheck = document.getElementById('btnCheck');
                    if (btnCheck) {
                        btnCheck.disabled = false;
                        btnCheck.classList.remove('d-none');
                        // Reset button text just in case
                        btnCheck.innerHTML = '<i class="bi bi-search me-2"></i>Check Camera';
                    }
                }
            });
        }
    });

    function loadCameras() {
        const select = document.getElementById('cameraSelect');
        if (!select) return;

        // Show loading state
        select.innerHTML = '<option value="" disabled selected>‚è≥ Memuat daftar kamera...</option>';

        fetch('/api/cameras')
            .then(res => res.json())
            .then(data => {
                const cameras = data.cameras || [];
                select.innerHTML = '<option value="" disabled selected>Pilih Kamera</option>';

                if (cameras.length === 0) {
                    const option = document.createElement('option');
                    option.text = "Tidak ada kamera ditemukan";
                    select.add(option);
                    return;
                }

                // Get saved selection
                const savedCamera = localStorage.getItem('last_camera_url');
                let foundSaved = false;

                cameras.forEach((cam, index) => {
                    const option = document.createElement('option');
                    option.value = cam.url;
                    option.text = cam.name || `Camera ${index + 1}`;

                    // Connect to saved camera if exists
                    if (savedCamera && cam.url === savedCamera) {
                        option.selected = true;
                        foundSaved = true;
                    }

                    select.add(option);
                });

                // If saved found, update global var but wait for user to click check
                if (foundSaved) {
                    selectedCameraUrl = savedCamera;
                    // Optional: Enable check button immediately
                    const btnCheck = document.getElementById('btnCheck');
                    if (btnCheck) {
                        btnCheck.disabled = false;
                    }
                }

                // Add Local Client Camera option
                const localOption = document.createElement('option');
                localOption.value = 'local_client_device';
                localOption.text = 'üì± Local Camera (Client Device)';
                localOption.style.fontWeight = 'bold';
                select.add(localOption);

                const separator = document.createElement('option');
                separator.disabled = true;
                separator.text = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                select.add(separator);

                // Add "Add New Camera" option
                const addOption = document.createElement('option');
                addOption.value = '__add_new__';
                addOption.text = '‚ûï Tambah Kamera Baru';
                select.add(addOption);

                // Initial update
                updateCameraInfo();
            })
            .catch(err => {
                console.error('Failed to load cameras', err);
                select.innerHTML = '<option>‚ùå Error memuat kamera</option>';
            });
    }

    function updateCameraInfo() {
        const select = document.getElementById('cameraSelect');
        const url = select.value;
        const btnCheck = document.getElementById('btnCheck');

        // Handle "Add New Camera"
        if (url === '__add_new__') {
            window.location.href = '/camera-settings';
            return;
        }

        // 1. Matikan kamera sebelumnya jik ada (Release OLD first)
        if (selectedCameraUrl && selectedCameraUrl !== url) {
            console.log('>>> [Camera] Switching... Releasing old camera:', selectedCameraUrl);
            const data = JSON.stringify({ url: selectedCameraUrl });
            fetch('/api/camera/release', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                keepalive: true,
                body: data
            }).catch(e => console.log('Release failed', e));
        }

        const infoUrl = document.getElementById('info-url');
        if (infoUrl && url) infoUrl.textContent = url;

        // Update selected URL
        selectedCameraUrl = url;

        // Update Check Button State
        if (btnCheck) {
            btnCheck.disabled = !url;
            btnCheck.innerHTML = '<i class="bi bi-search me-2"></i>Check Camera';
        }

        // When camera changes, reset the UI
        resetUI(true);
    }

    function resetUI(keepSelection = false) {
        // Clear health check
        if (healthCheckInterval) {
            clearInterval(healthCheckInterval);
            healthCheckInterval = null;
        }

        // Reset Visuals
        document.getElementById('cameraPlaceholder').classList.remove('d-none');
        const liveStream = document.getElementById('liveStream');
        liveStream.classList.add('d-none');
        liveStream.removeAttribute('src'); // Stop stream

        // Stop Local Stream
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
            localVideo.classList.add('d-none');
            localVideo.pause();
            localVideo.srcObject = null;
        }
        if (window.localStream) {
            window.localStream.getTracks().forEach(track => track.stop());
            window.localStream = null;
        }

        // document.getElementById('capturedImage').classList.add('d-none');
        document.getElementById('feedbackArea').innerHTML = '';

        // Reset Buttons
        const btnCheck = document.getElementById('btnCheck');
        const btnCapture = document.getElementById('btnCapture');
        const btnReset = document.getElementById('btnReset');

        if (btnCheck) {
            btnCheck.classList.remove('d-none');
            btnCheck.disabled = !document.getElementById('cameraSelect').value;
            // FIX: Reset button text
            btnCheck.innerHTML = '<i class="bi bi-search me-2"></i>Check Camera';
        }

        if (btnCapture) btnCapture.classList.add('d-none');
        if (btnReset) btnReset.classList.add('d-none');

        if (!keepSelection) {
            const select = document.getElementById('cameraSelect');
            if (select) select.value = "";
            selectedCameraUrl = '';
        }

        // Hide zoom controls
        document.getElementById('zoomContainer').classList.add('d-none');
        document.getElementById('zoomIndicator').style.display = 'none';
        currentZoom = 1.0;
    }

    // [ANTIGRAVITY] ADDED PAGE CLEANUP
    window.addEventListener('beforeunload', function () {
        if (selectedCameraUrl && selectedCameraUrl !== 'local_client_device') {
            const data = JSON.stringify({ url: selectedCameraUrl });
            if (navigator.sendBeacon) {
                const blob = new Blob([data], { type: 'application/json' });
                navigator.sendBeacon('/api/camera/release', blob);
            } else {
                fetch('/api/camera/release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: data
                });
            }
        }
    });

    function checkCamera() {
        const select = document.getElementById('cameraSelect');
        const url = select.value;
        const btnCheck = document.getElementById('btnCheck');
        const feedback = document.getElementById('feedbackArea');

        if (!url) {
            alert('Pilih kamera terlebih dahulu!');
            return;
        }

        // Update selected URL
        selectedCameraUrl = url;

        // Show loading feedback
        btnCheck.disabled = true;
        btnCheck.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menghubungkan...';
        // feedback.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-hourglass-split me-2"></i>Menghubungkan ke kamera...</div>';

        // Start preview (same logic as recording.html)
        startPreview();
    }

    function startPreview() {
        // [ANTIGRAVITY] Set high FPS for smooth preview
        if (selectedCameraUrl && selectedCameraUrl !== 'local_client_device') {
            fetch('/api/camera/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                keepalive: true,
                body: JSON.stringify({
                    url: selectedCameraUrl,
                    mode: 'scan' // 20 FPS for smooth preview
                })
            }).catch(e => console.log('Set mode failed', e));
        }

        // Clear any existing health check
        if (healthCheckInterval) clearInterval(healthCheckInterval);

        const img = document.getElementById('liveStream');
        const video = document.getElementById('localVideo'); // Local Video Element
        const placeholder = document.getElementById('cameraPlaceholder');
        const feedback = document.getElementById('feedbackArea');

        // Reset state
        img.style.display = 'none'; img.classList.add('d-none');
        video.style.display = 'none'; video.classList.add('d-none');

        // Stop any existing local stream
        if (window.localStream) {
            window.localStream.getTracks().forEach(track => track.stop());
            window.localStream = null;
        }

        placeholder.classList.remove('d-none');
        placeholder.style.display = 'flex';
        placeholder.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="text-light">Menghubungkan...</h4>
                <p class="text-muted">Sedang mencoba koneksi ke kamera...</p>
            </div>
        `;

        // 3. Define disconnect UI Helper
        const showDisconnectUI = (msg = null) => {
            if (healthCheckInterval) clearInterval(healthCheckInterval);
            const btnCheck = document.getElementById('btnCheck');
            const disconnectMsg = msg || "Kamera tidak merespon atau koneksi hilang.";

            feedback.innerHTML = `
                <div class="alert alert-danger d-flex align-items-center mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <div><strong>Koneksi Gagal</strong><br>${disconnectMsg}</div>
                </div>
            `;

            // Hide media
            img.style.display = 'none'; img.classList.add('d-none'); img.removeAttribute('src');
            video.style.display = 'none'; video.classList.add('d-none');

            // Show placeholder with retry
            placeholder.classList.remove('d-none');
            placeholder.style.display = 'flex';
            placeholder.innerHTML = `
                <div class="text-center">
                    <i class="fs-1 mb-3 text-danger">‚ö†Ô∏è</i>
                    <h4 class="text-danger">Koneksi Terputus</h4>
                    <p class="text-light">${disconnectMsg}</p>
                    <button class="btn btn-primary mt-2" onclick="startPreview()">üîÑ Hubungkan Ulang</button>
                </div>
            `;

            // Reset buttons
            btnCheck.classList.remove('d-none');
            btnCheck.disabled = false;
            btnCheck.innerHTML = '<i class="bi bi-search me-2"></i>Check Camera';
            document.getElementById('btnCapture').classList.add('d-none');
            document.getElementById('btnReset').classList.add('d-none');
        };

        // --- LOCAL CAMERA LOGIC ---
        if (selectedCameraUrl === 'local_client_device') {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showDisconnectUI("Browser Anda tidak mendukung akses kamera (HTTPS required).");
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    window.localStream = stream;
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();

                        // UI SUCCESS
                        feedback.innerHTML = `
                            <div class="alert alert-success d-flex align-items-center mb-0">
                                <i class="bi bi-camera-video-fill me-2 fs-5"></i>
                                <div><strong>üü¢ Local Camera Online</strong></div>
                            </div>
                        `;
                        placeholder.classList.add('d-none');
                        placeholder.style.display = 'none';
                        video.classList.remove('d-none');
                        video.style.display = 'block';

                        document.getElementById('btnCheck').classList.add('d-none');
                        document.getElementById('btnCapture').classList.remove('d-none');
                        document.getElementById('btnReset').classList.remove('d-none');

                        // Hide zoom for local (not supported via web API easily yet)
                        document.getElementById('zoomContainer').classList.add('d-none');
                    };
                })
                .catch(err => {
                    console.error("Local Cam Error:", err);
                    showDisconnectUI("Gagal membuka kamera lokal. Izin ditolak atau tidak ditemukan.");
                });
            return;
        }

        // --- BACKEND STREAM LOGIC ---
        // Setup stream handlers with Retry Logic
        let retryCount = 0;
        const maxRetries = 3;

        img.onload = function () {
            retryCount = 0;

            feedback.innerHTML = `
                <div class="alert alert-success d-flex align-items-center mb-0">
                    <i class="bi bi-camera-video-fill me-2 fs-5"></i>
                    <div><strong>üü¢ Kamera Online (Stream)</strong></div>
                </div>
            `;

            // Ensure placeholder is gone
            placeholder.classList.add('d-none');
            placeholder.style.display = 'none';

            // Show capture button
            document.getElementById('btnCheck').classList.add('d-none');
            document.getElementById('btnCapture').classList.remove('d-none');
            document.getElementById('btnReset').classList.remove('d-none');

            // Force show image (remove all hiding methods)
            img.classList.remove('d-none');
            img.style.display = 'block';
            img.style.visibility = 'visible';

            // Show zoom controls
            document.getElementById('zoomContainer').classList.remove('d-none');
            resetZoom();
        };

        img.onerror = function () {
            console.log('>>> [Preview] Image load error triggered');

            if (retryCount < maxRetries) {
                retryCount++;
                console.log(`>>> [Preview] Retrying connection (${retryCount}/${maxRetries})...`);

                // Update UI to show retry
                const spinner = placeholder.querySelector('p.text-muted');
                if (spinner) spinner.textContent = `Mencoba menghubungkan ulang (${retryCount})...`;

                // Try reload with delay
                setTimeout(() => {
                    img.src = `/video_feed?url=${encodeURIComponent(selectedCameraUrl)}&t=${Date.now()}`;
                }, 1500);
            } else {
                showDisconnectUI();
            }
        };

        // Set stream source with cache buster
        img.src = `/video_feed?url=${encodeURIComponent(selectedCameraUrl)}&t=${new Date().getTime()}`;

        // HEALTH CHECK: Poll every 2 seconds
        if (healthCheckInterval) clearInterval(healthCheckInterval);

        healthCheckInterval = setInterval(() => {
            if (!selectedCameraUrl || selectedCameraUrl === 'local_client_device') return;

            fetch(`/api/camera/check?url=${encodeURIComponent(selectedCameraUrl)}&t=${Date.now()}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.active) {
                        console.log('>>> [Health Check] Camera died, triggering disconnect UI');
                        clearInterval(healthCheckInterval);
                        showDisconnectUI();
                    }
                })
                .catch(err => console.log('Health check failed', err));
        }, 2000);

        // TIMEOUT CHECK: 10 seconds
        setTimeout(() => {
            if (feedback.innerHTML.includes('Menghubungkan')) {
                // Still connecting after 10s = timeout
                showDisconnectUI("Kamera tidak merespon dalam 10 detik (Timeout).");
            }
        }, 10000);
    }

    // RENAMED TO performCapture TO AVOID CONFLICT WITH app.js' captureFrame
    function performCapture() {
        // --- LOCAL CAPTURE LOGIC ---
        if (selectedCameraUrl === 'local_client_device') {
            const video = document.getElementById('localVideo');
            const canvas = document.getElementById('localCanvas');
            const feedback = document.getElementById('feedbackArea');

            if (!video || !window.localStream) {
                alert("Local camera not active!");
                return;
            }

            try {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Get Base64
                const dataURL = canvas.toDataURL('image/jpeg', 0.95);

                // Show Modal Manually
                const modalImg = document.getElementById('modalCaptureImage');
                const downloadBtn = document.getElementById('btnDownloadModal');
                const modalEl = document.getElementById('captureModal');

                if (modalImg) modalImg.src = dataURL;
                if (downloadBtn) {
                    downloadBtn.href = dataURL;
                    downloadBtn.setAttribute('download', `local_capture_${Date.now()}.jpg`);
                }

                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();

            } catch (e) {
                console.error("Local capture error", e);
                feedback.innerHTML = `<div class="alert alert-danger">Capture failed: ${e.message}</div>`;
            }
            return;
        }

        // --- BACKEND CAPTURE LOGIC (EXISTING) ---
        const select = document.getElementById('cameraSelect');
        const url = select.value;
        const btnCapture = document.getElementById('btnCapture');
        const feedback = document.getElementById('feedbackArea');

        console.log('[Capture] Starting capture process (performCapture)...');

        // Loading
        btnCapture.disabled = true;
        btnCapture.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Capturing...';

        fetch('/api/camera/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
            .then(res => {
                console.log('[Capture] Response received:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('[Capture] Data received:', data);
                if (data.success) {
                    // SUCCESS - Show Modal
                    console.log('[Capture] Success! Preparing modal...');
                    try {
                        const modalImg = document.getElementById('modalCaptureImage');
                        const downloadBtn = document.getElementById('btnDownloadModal');
                        const modalEl = document.getElementById('captureModal');

                        // Check elements
                        if (!modalImg) {
                            console.error('[Capture] Error: modalCaptureImage not found');
                            alert('Dev Error: modalCaptureImage missing');
                        }
                        if (!downloadBtn) console.error('[Capture] Error: btnDownloadModal not found');
                        if (!modalEl) console.error('[Capture] Error: captureModal not found');

                        if (!modalEl) {
                            alert('Critical: captureModal element not found!');
                            return;
                        }

                        // Set content (safely)
                        if (modalImg) modalImg.src = data.image_base64;
                        if (downloadBtn) {
                            downloadBtn.href = data.image_base64;
                            downloadBtn.setAttribute('download', data.filename || 'capture.jpg');
                        }

                        // ALERT SUCCESS to confirm execution
                        // alert("Capture Successful! Opening Image...");

                        // Initialize and show modal
                        console.log('[Capture] Initializing Bootstrap Modal check...');
                        if (typeof bootstrap === 'undefined') {
                            console.error('[Capture] Bootstrap is not defined!');
                            alert('Internal Error: Bootstrap library not loaded.');
                            return;
                        }

                        // Use getOrCreateInstance
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        console.log('[Capture] Showing modal...');
                        modal.show();

                        // Clear feedback
                        if (feedback) feedback.innerHTML = '';

                    } catch (e) {
                        console.error('[Capture] Exception in success block:', e);
                        alert('Frontend Logic Error: ' + e.message);
                        if (feedback) feedback.innerHTML = `<div class="alert alert-danger">Frontend Error: ${e.message}</div>`;
                    }

                } else {
                    // ERROR
                    console.warn('[Capture] Server returned error:', data.error);
                    if (feedback) {
                        feedback.innerHTML = `
                            <div class="alert alert-warning">
                                <strong><i class="bi bi-x-circle me-2"></i>Gagal Capture!</strong><br>
                                ${data.error}
                            </div>
                        `;
                    }
                }
            })
            .catch(err => {
                console.error('[Capture] Fetch/Network Error:', err);
                alert('Fetch Error: ' + err.message);
                if (feedback) feedback.innerHTML = `<div class="alert alert-danger">System Error: ${err.message}</div>`;
            })
            .finally(() => {
                console.log('[Capture] Cleanup...');
                // Return button to normal
                if (btnCapture) {
                    btnCapture.disabled = false;
                    btnCapture.innerHTML = '<i class="bi bi-camera me-2"></i>Ambil Gambar';

                    // Ensure it is visible
                    btnCapture.classList.remove('d-none');
                }
            });
    }

    // Zoom Functions
    function adjustZoom(delta) {
        if (!selectedCameraUrl) return;

        let newZoom = currentZoom + delta;
        if (newZoom < 1.0) newZoom = 1.0;
        if (newZoom > 4.0) newZoom = 4.0;

        if (newZoom === currentZoom) return;

        currentZoom = newZoom;
        sendZoomRequest();
    }

    function resetZoom() {
        if (!selectedCameraUrl) return;
        currentZoom = 1.0;
        sendZoomRequest();
    }

    function sendZoomRequest() {
        if (!selectedCameraUrl) return;

        const indicator = document.getElementById('zoomIndicator');
        if (currentZoom > 1.0) {
            indicator.style.display = 'block';
            indicator.textContent = `Zoom: ${currentZoom.toFixed(1)}x`;
        } else {
            indicator.style.display = 'none';
        }

        fetch('/api/camera/zoom', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: selectedCameraUrl,
                level: currentZoom
            })
        })
            .then(res => res.json())
            .then(data => {
                if (!data.success) console.error('Zoom failed:', data.message);
            })
            .catch(err => console.error('Zoom error:', err));
    }

    // Cleanup on exit
    window.addEventListener('beforeunload', function () {
        if (selectedCameraUrl) {
            const data = JSON.stringify({ url: selectedCameraUrl });
            // Try sendBeacon first
            if (navigator.sendBeacon) {
                navigator.sendBeacon('/api/camera/release', new Blob([data], { type: 'application/json' }));
            } else {
                // Fallback
                fetch('/api/camera/release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: data
                });
            }
        }
    });
</script>
{% endblock %}