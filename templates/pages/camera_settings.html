{% extends "base.html" %}
{% block title %}Pengaturan Kamera - AYZARA Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìπ Pengaturan Kamera</h1>
    <p>Kelola daftar kamera IP untuk recording</p>
</div>


<!-- Daftar Kamera -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>üìã Daftar Kamera</h3>
        <div class="header-actions">
            <button class="btn btn-info" onclick="startDiscovery()">
                üîç Discovery Kamera
            </button>
            <button class="btn btn-primary" onclick="showAddCameraModal()">
                ‚ûï Tambah Kamera
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table" id="camera-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Nama</th>
                        <th>URL</th>
                        <th>Aktif</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="camera-list">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Memuat daftar kamera...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Tambah/Edit Kamera -->
<div class="modal" id="camera-modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCameraModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Tambah Kamera</h3>
            <button class="modal-close" onclick="closeCameraModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Discovery Section -->
            <div id="discovery-section">
                <div class="discovery-loading text-center py-4" id="discovery-loading" style="display: none;">
                    <div class="spinner mb-2"></div>
                    <p>Mencari kamera di jaringan lokal...</p>
                </div>

                <div id="discovery-results" style="display: none;">
                    <p class="mb-3 text-secondary" style="font-size: 14px;">Ditemukan beberapa kamera potensial:</p>
                    <div class="discovery-list mb-4" id="discovery-list">
                        <!-- Discovered cameras will be listed here -->
                    </div>
                    <div class="text-center">
                        <button class="btn btn-glass w-100 py-3" style="border-style: dashed; border-width: 2px;"
                            onclick="switchToManualInput()">
                            ‚å®Ô∏è Input Manual (Gunakan URL Sendiri)
                        </button>
                    </div>
                </div>

                <div id="discovery-empty" class="text-center py-4" style="display: none;">
                    <p class="text-muted mb-3">Tidak ada kamera yang ditemukan otomatis.</p>
                    <button class="btn btn-primary" onclick="switchToManualInput()">
                        Keyboard Input Manual
                    </button>
                </div>
            </div>

            <!-- Form Section -->
            <form id="camera-form" style="display: none;">
                <input type="hidden" id="camera-id" value="">

                <div class="form-group">
                    <label for="camera-name">Nama Kamera</label>
                    <input type="text" id="camera-name" class="form-control" placeholder="Contoh: Gudang WiFi A"
                        required>
                </div>

                <div class="form-group">
                    <label for="camera-url">URL RTSP</label>
                    <input type="text" id="camera-url" class="form-control"
                        placeholder="rtsp://admin:password@192.168.1.10:554/stream" required>
                    <small class="form-text text-muted">
                        Format: rtsp://[username]:[password]@[IP]:[port]/[path]
                    </small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="camera-enabled" checked>
                        <span>Kamera Aktif (Enabled)</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCameraModal()">
                        Batal
                    </button>
                    <button type="button" class="btn btn-info" onclick="testCameraConnection()">
                        üîç Test Koneksi
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Panduan -->
<div class="card">
    <div class="card-header">
        <h3>üìñ Panduan</h3>
    </div>
    <div class="card-body">
        <div class="help-section">
            <h4>Cara Menambah Kamera:</h4>
            <ol>
                <li>Klik tombol "Tambah Kamera"</li>
                <li>Isi nama kamera (sebagai penanda, misal: "Kamera Gudang 1")</li>
                <li>Masukkan URL RTSP atau MJPEG kamera</li>
                <li>Klik "Test Koneksi" untuk memastikan kamera terjangkau oleh server</li>
                <li>Klik "Simpan" untuk mengaktifkan kamera dalam dashboard</li>
            </ol>

            <h4>Keterangan Status:</h4>
            <ul>
                <li><strong>Online (Probed):</strong> Kamera berhasil dihubungi secara real-time via FFprobe/Socket.
                </li>
                <li><strong>Offline:</strong> Kamera tidak merespon atau URL salah. Gunakan tombol "Test" untuk refresh
                    paksa.</li>
                <li><strong>In Use:</strong> Kamera sedang digunakan oleh user tertentu untuk preview atau recording.
                </li>
            </ul>

            <h4>Tips:</h4>
            <ul>
                <li>Simpan beberapa kamera sebagai backup jika salah satu WiFi mati.</li>
                <li>Gunakan <strong>Metode Input</strong> manual di halaman Rekam jika scanner fisik bermasalah.</li>
                <li>Status kamera akan di-refresh otomatis setiap 15 detik di halaman ini.</li>
            </ul>
        </div>
    </div>
</div>

<style>
    /* Modal Styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background: #0f0f1a;
        /* Solid background to prevent transparency issues */
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        margin: 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        font-size: 20px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .modal-close:hover {
        color: var(--text-color);
    }

    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        color: white;
        font-size: 14px;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .form-text {
        font-size: 12px;
        margin-top: 4px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .checkbox-label input {
        width: 18px;
        height: 18px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    /* Camera Status */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-online {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-offline {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .status-checking {
        background: rgba(234, 179, 8, 0.2);
        color: #eab308;
    }

    .url-text {
        font-family: monospace;
        font-size: 12px;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Help Section */
    .help-section h4 {
        margin-top: 20px;
        margin-bottom: 10px;
        color: var(--primary-color);
    }

    .help-section ol,
    .help-section ul {
        margin-left: 20px;
    }

    .help-section li {
        margin-bottom: 8px;
    }

    /* Discovery UI */
    .header-actions {
        display: flex;
        gap: 10px;
    }

    .discovery-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
    }

    .discovery-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .discovery-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .discovery-info {
        display: flex;
        flex-direction: column;
    }

    .discovery-name {
        font-weight: 600;
        font-size: 14px;
    }

    .discovery-ip {
        font-size: 12px;
        color: var(--text-secondary);
        font-family: monospace;
    }

    .discovery-source {
        font-size: 10px;
        padding: 2px 6px;
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border-radius: 4px;
        width: fit-content;
        margin-top: 4px;
    }

    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    // Global variables
    let cameras = [];

    let cameraStatusInterval = null;

    // Load cameras on page load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('>>> [Camera Settings] Page loaded, starting background status checks');
        loadCameras();

        // Start periodic status refresh while on this page (background, cached)
        cameraStatusInterval = setInterval(() => {
            refreshAllCameraStatuses();
        }, 30000); // every 30s

        // Stop background checks when leaving page
        window.addEventListener('beforeunload', () => {
            console.log('>>> [Camera Settings] Page unloading, stopping background checks');
            if (cameraStatusInterval) {
                clearInterval(cameraStatusInterval);
                cameraStatusInterval = null;
            }
        });

        // Pause/resume background checks based on page visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden (user switched tab/minimized)
                console.log('>>> [Camera Settings] Page hidden, pausing background checks');
                if (cameraStatusInterval) {
                    clearInterval(cameraStatusInterval);
                    cameraStatusInterval = null;
                }
            } else {
                // Page is visible again
                console.log('>>> [Camera Settings] Page visible, resuming background checks');
                if (!cameraStatusInterval) {
                    // Refresh immediately
                    refreshAllCameraStatuses();
                    // Then start interval
                    cameraStatusInterval = setInterval(() => {
                        refreshAllCameraStatuses();
                    }, 30000); // every 30s
                }
            }
        });
    });

    // Load camera list from API
    function loadCameras() {
        fetch('/api/cameras')
            .then(response => response.json())
            .then(data => {
                cameras = data.cameras || [];
                renderCameraList();
            })
            .catch(error => {
                console.error('Error loading cameras:', error);
                document.getElementById('camera-list').innerHTML =
                    '<tr><td colspan="5" class="text-center text-danger">Gagal memuat daftar kamera</td></tr>';
            });
    }

    // Render camera list table
    function renderCameraList() {
        const tbody = document.getElementById('camera-list');

        if (cameras.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada kamera. Klik "Tambah Kamera" untuk menambahkan.</td></tr>';
            return;
        }

        tbody.innerHTML = cameras.map((cam, idx) => `
        <tr data-id="${cam.id}">
            <td>
                <span class="status-badge status-checking" id="status-${idx}">
                    ‚è≥ Mengecek...
                </span>
            </td>
            <td><strong>${escapeHtml(cam.name)}</strong></td>
            <td><span class="url-text" title="${escapeHtml(cam.url)}">${escapeHtml(cam.url)}</span></td>
            <td>
                <span class="status-badge ${cam.enabled ? 'status-online' : 'status-offline'}">
                    ${cam.enabled ? '‚úÖ Aktif' : '‚ùå Disabled'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info" onclick="testCamera(${idx})">üîç Test</button>
                <button class="btn btn-sm btn-secondary" onclick="editCamera(${idx})">‚úèÔ∏è Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCamera(${idx})">üóëÔ∏è Hapus</button>
            </td>
        </tr>
    `).join('');

        // Initial status load
        refreshAllCameraStatuses();

        // Auto-refresh status every 30 seconds
        if (window.statusRefreshInterval) clearInterval(window.statusRefreshInterval);
        window.statusRefreshInterval = setInterval(refreshAllCameraStatuses, 30000);
    }


    // Refresh all camera statuses from cache (non-blocking)
    function refreshAllCameraStatuses() {
        if (!cameras || cameras.length === 0) return;

        fetch('/api/cameras/status')
            .then(response => response.json())
            .then(data => {
                const statusMap = data.status || {};

                cameras.forEach((cam, idx) => {
                    const badge = document.getElementById(`status-${idx}`);
                    if (!badge) return;

                    const cameraStatus = statusMap[cam.url] || Object.values(statusMap).find(s => s.url === cam.url);

                    if (cameraStatus) {
                        if (cameraStatus.online) {
                            badge.className = 'status-badge status-online';
                            if (cameraStatus.in_use && cameraStatus.in_use_by) {
                                badge.innerHTML = `üü¢ Online<br><small>Dipakai oleh ${escapeHtml(cameraStatus.in_use_by)}${cameraStatus.purpose ? ' (' + escapeHtml(cameraStatus.purpose) + ')' : ''}</small>`;
                            } else {
                                badge.innerHTML = 'üü¢ Online';
                            }
                        } else {
                            badge.className = 'status-badge status-offline';
                            badge.innerHTML = 'üî¥ Offline';
                        }
                    } else {
                        // Status not yet checked by background worker
                        badge.className = 'status-badge status-checking';
                        badge.innerHTML = '‚è≥ Menunggu...';
                    }
                });
            })
            .catch(() => {
                cameras.forEach((cam, idx) => {
                    const badge = document.getElementById(`status-${idx}`);
                    if (badge) {
                        badge.className = 'status-badge status-offline';
                        badge.innerHTML = '‚ùì Tidak Diketahui';
                    }
                });
            });
    }

    // Show add camera modal
    function showAddCameraModal() {
        document.getElementById('modal-title').textContent = 'Tambah Kamera';
        document.getElementById('camera-id').value = '';
        document.getElementById('camera-name').value = '';
        document.getElementById('camera-url').value = '';
        document.getElementById('camera-enabled').checked = true;

        // Default to discovery view
        startDiscovery();

        document.getElementById('camera-modal').style.display = 'flex';
    }

    function startDiscovery() {
        document.getElementById('modal-title').textContent = 'Discovery Kamera';
        document.getElementById('discovery-section').style.display = 'block';
        document.getElementById('camera-form').style.display = 'none';

        document.getElementById('discovery-loading').style.display = 'block';
        document.getElementById('discovery-results').style.display = 'none';
        document.getElementById('discovery-empty').style.display = 'none';

        document.getElementById('camera-modal').style.display = 'flex';

        fetch('/api/cameras/discover')
            .then(response => response.json())
            .then(data => {
                document.getElementById('discovery-loading').style.display = 'none';

                if (data.success && data.cameras && data.cameras.length > 0) {
                    renderDiscoveryResults(data.cameras);
                } else {
                    document.getElementById('discovery-empty').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Discovery error:', error);
                document.getElementById('discovery-loading').style.display = 'none';
                document.getElementById('discovery-empty').style.display = 'block';
            });
    }

    function renderDiscoveryResults(discovered) {
        const list = document.getElementById('discovery-list');
        list.innerHTML = discovered.map(cam => `
            <div class="discovery-item">
                <div class="discovery-info">
                    <span class="discovery-name">${escapeHtml(cam.name)}</span>
                    <span class="discovery-ip">${cam.ip}</span>
                    <span class="discovery-source"><i class="bi bi-broadcast"></i> ${cam.source}</span>
                </div>
                <button class="btn btn-sm btn-primary px-3" onclick="useDiscoveredCamera('${cam.name}', '${cam.url}')">
                    <i class="bi bi-plus-lg me-1"></i> Gunakan
                </button>
            </div>
        `).join('');

        document.getElementById('discovery-results').style.display = 'block';
    }

    function useDiscoveredCamera(name, url) {
        document.getElementById('camera-name').value = name;
        document.getElementById('camera-url').value = url;
        switchToManualInput();
    }

    function switchToManualInput() {
        document.getElementById('modal-title').textContent = document.getElementById('camera-id').value ? 'Edit Kamera' : 'Tambah Kamera';
        document.getElementById('discovery-section').style.display = 'none';
        document.getElementById('camera-form').style.display = 'block';
    }

    // Close modal
    function closeCameraModal() {
        document.getElementById('camera-modal').style.display = 'none';
    }

    // Edit camera
    function editCamera(idx) {
        const cam = cameras[idx];
        document.getElementById('modal-title').textContent = 'Edit Kamera';
        document.getElementById('camera-id').value = cam.id;
        document.getElementById('camera-name').value = cam.name;
        document.getElementById('camera-url').value = cam.url;
        document.getElementById('camera-enabled').checked = cam.enabled;

        // Hide discovery, show form directly for edit
        document.getElementById('discovery-section').style.display = 'none';
        document.getElementById('camera-form').style.display = 'block';

        document.getElementById('camera-modal').style.display = 'flex';
    }

    // Test camera connection from modal
    function testCameraConnection() {
        const url = document.getElementById('camera-url').value;
        if (!url) {
            alert('Masukkan URL kamera terlebih dahulu');
            return;
        }

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '‚è≥ Mengetes...';

        fetch('/api/cameras/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Koneksi berhasil! Kamera dapat digunakan.');
                } else {
                    console.log(data)
                    alert('‚ùå Koneksi gagal: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Error: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'üîç Test Koneksi';
            });
    }

    // Test camera from table
    function testCamera(idx) {
        const cam = cameras[idx];
        const badge = document.getElementById(`status-${idx}`);

        badge.className = 'status-badge status-checking';
        badge.innerHTML = '‚è≥ Mengetes...';

        fetch('/api/cameras/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: cam.url })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    badge.className = 'status-badge status-online';
                    badge.innerHTML = 'üü¢ Online';
                } else {
                    badge.className = 'status-badge status-offline';
                    badge.innerHTML = 'üî¥ Offline';
                }
            })
            .catch(error => {
                badge.className = 'status-badge status-offline';
                badge.innerHTML = '‚ùì Error';
            });
    }

    // Delete camera
    function deleteCamera(idx) {
        const cam = cameras[idx];

        Swal.fire({
            title: 'Hapus Kamera?',
            text: `Apakah Anda yakin ingin menghapus kamera "${cam.name}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Hapus',
            cancelButtonText: 'Batal',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/cameras/${cam.id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Berhasil',
                                text: 'Kamera telah dihapus.',
                                timer: 1500,
                                showConfirmButton: false
                            });
                            loadCameras();
                        } else {
                            Swal.fire('Gagal', data.message, 'error');
                        }
                    })
                    .catch(error => Swal.fire('Error', error.message, 'error'));
            }
        });
    }

    // Form submit
    document.getElementById('camera-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const id = document.getElementById('camera-id').value;
        const data = {
            name: document.getElementById('camera-name').value,
            url: document.getElementById('camera-url').value,
            enabled: document.getElementById('camera-enabled').checked
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/cameras/${id}` : '/api/cameras';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    closeCameraModal();
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Pengaturan kamera disimpan.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadCameras();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Menyimpan',
                        text: result.message,
                        confirmButtonText: 'Tutup'
                    });
                }
            })
            .catch(error => {
                Swal.fire('Error', error.message, 'error');
            });
    });

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}