{% extends "base.html" %}

{% block title %}Rekam Packing - AYZARA Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-box-seam"></i> Rekam Packing</h1>
                <p class="text-muted">Scan resi dan rekam proses packing secara otomatis</p>
            </div>

        </div>
    </div>
</div>

<style>
    #scan-visual-overlay {
        pointer-events: none;
        border: 4px solid rgba(40, 167, 69, 0.85);
        box-shadow: 0 0 18px rgba(40, 167, 69, 0.6);
        animation: scanPulse 1.4s ease-in-out infinite;
        border-radius: 8px;
    }

    @keyframes scanPulse {
        0% {
            opacity: 0.35;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.35;
        }
    }


    /* Orange Button Styles (replacing yellow warning) */
    .btn-outline-orange {
        color: #FF6B35;
        border-color: #FF6B35;
    }

    .btn-outline-orange:hover {
        color: #fff;
        background-color: #FF6B35;
        border-color: #FF6B35;
    }

    .btn-check:checked+.btn-outline-orange {
        color: #fff;
        background-color: #FF6B35;
        border-color: #FF6B35;
    }

    .btn-check:active+.btn-outline-orange,
    .btn-outline-orange:active,
    .btn-outline-orange.active {
        color: #fff;
        background-color: #E55A2B;
        border-color: #E55A2B;
    }


    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
        transition: opacity 0.3s;
    }

    .zoom-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .zoom-btn:hover {
        background: rgba(40, 167, 69, 0.6);
        transform: scale(1.1);
    }

    .zoom-btn:active {
        transform: scale(0.9);
    }

    .zoom-info {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        pointer-events: none;
        z-index: 100;
        display: none;
    }

    /* MOBILE FIXES */
    @media (max-width: 768px) {
        #camera-container {
            min-height: 250px !important;
            /* Reduced from 480px */
            height: auto;
            aspect-ratio: 16/9;
        }

        /* Adjust scanner area for mobile */
        #scanner-container {
            min-height: 120px !important;
        }

        .input-group-lg>.form-control,
        .input-group-lg>.input-group-text {
            font-size: 1rem;
            /* Smaller text on mobile */
        }
    }

    /* FAB (Floating Action Button) */
    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        gap: 10px;
    }

    .fab-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color, #0d6efd);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .fab-btn:hover {
        transform: scale(1.1);
        background: #FF6B35;
    }


    .fab-item {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #343a40;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.2s;
        position: relative;
    }



    .fab-item:hover {
        background: var(--primary-color, #FF6B35);
        transform: scale(1.1);
    }

    .fab-tooltip {
        position: absolute;
        right: 50px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .fab-item:hover .fab-tooltip {
        opacity: 1;
    }
</style>

<div class="row">
    <!-- Left Column: Controls -->
    <div class="col-md-4">
        <!-- Input Method & Camera -->
        <!-- Input Method & Camera -->
        <div class="card mb-3">
            <div class="card-header">
                <h5>1. Pengaturan Kamera</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Metode Input Resi</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="input-method" id="method-scanner" value="scanner">
                        <label class="btn btn-outline-orange" for="method-scanner"><i class="bi bi-phone me-1"></i>
                            Scanner Barcode</label>

                        <input type="radio" class="btn-check" name="input-method" id="method-camera" value="camera"
                            checked>
                        <label class="btn btn-outline-orange" for="method-camera"><i class="bi bi-camera me-1"></i>
                            Deteksi Kamera</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Konfigurasi Kamera</label>

                    <!-- Scanning Camera (Conditional) - NOW ON TOP -->
                    <div class="mb-3" id="scan-camera-row" style="display:none;">
                        <label class="form-label small text-muted mb-1"><i class="bi bi-upc-scan me-1"></i> Kamera
                            Scanner (Barcode)</label>
                        <div class="input-group">
                            <select id="camera-select-scanning" class="form-select"
                                onchange="handleScanningCameraChange(this.value)">
                                <option value="" disabled selected>Pilih kamera scan...</option>
                            </select>
                            <button class="btn btn-outline-orange" type="button" onclick="connectScanningCamera()"
                                title="Connect/Reload" id="btn-connect-scan">
                                <i class="bi bi-play-fill"></i> Connect
                            </button>
                        </div>
                        <div id="scan-cam-error" class="invalid-feedback d-none mt-1"></div>
                        <div class="form-text small text-info">
                            <i class="bi bi-info-circle me-1"></i> Kamera scan bisa sama dengan perekam (Khusus sesama
                            Kamera Server).
                        </div>
                    </div>

                    <!-- Recording Camera (Always Visible) - NOW BELOW -->
                    <div class="mb-3">
                        <label class="form-label small text-muted mb-1"><i class="bi bi-camera-video me-1"></i> Kamera
                            Perekam (Video)</label>
                        <div class="input-group">
                            <select id="camera-select-recording" class="form-select"
                                onchange="handleRecordingCameraChange(this.value)">
                                <option value="" disabled selected>Pilih kamera rekam...</option>
                            </select>
                            <button class="btn btn-outline-orange" type="button" onclick="connectRecordingCamera()"
                                title="Connect/Reload" id="btn-connect-rec">
                                <i class="bi bi-play-fill"></i> Connect
                            </button>
                        </div>
                        <div id="rec-cam-error" class="invalid-feedback d-none mt-1"></div>
                    </div>

                    <hr>

                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="closeAllCameras()"
                            title="Tutup Kamera">
                            <i class="bi bi-x-circle me-1"></i> Tutup & Reset Semua
                        </button>

                        <div class="d-flex gap-2">
                            <button id="btn-toggle-voice" class="btn btn-success btn-sm flex-grow-1" type="button"
                                onclick="toggleVoiceNotification()" title="Toggle Notifikasi Suara">
                                <i class="bi bi-volume-up-fill me-1"></i> Suara ON
                            </button>
                            <button class="btn btn-outline-info btn-sm" type="button"
                                onclick="speakText('rekaman_dimulai')" title="Test Suara">
                                <i class="bi bi-play-fill"></i> Test
                            </button>
                        </div>
                    </div>

                    <small class="text-muted mt-2 d-block">
                        <i class="bi bi-info-circle me-1"></i>
                        Notifikasi suara vokal untuk status rekaman
                    </small>

                    <div id="camera-status-indicator" class="mt-2 text-muted small">
                        Pilih kamera untuk cek status
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Selection -->
        <div class="card mb-3" id="platform-card">
            <div class="card-header">
                <h5>2. Pilih Platform</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% for platform, data in platforms.items() %}
                    <button class="btn btn-lg btn-outline-secondary platform-btn" data-platform="{{ platform }}"
                        style="border-left: 5px solid {{ data.color }};">
                        {{ platform }}
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" id="selected-platform">

                <hr class="my-3">
                <div class="d-grid">
                    <button id="btn-reset-scanning" class="btn btn-outline-danger d-none" onclick="resetScanningState()"
                        title="Stop scanning and reset">
                        <i class="bi bi-stop-fill me-1"></i> Stop Scan Kamera
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Preview & Action -->
    <div class="col-md-8">

        <!-- TOP: SCANNER PREVIEW / INPUT -->
        <div class="card mb-3 border-primary shadow-sm">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-upc-scan me-2"></i>Scanner Area</h6>
                <span class="badge text-white" id="scan-status-badge" style="background-color: #FF6B35;">Ready</span>
            </div>

            <!-- Scanner Body -->
            <div id="scanner-container" class="card-body bg-dark text-center p-0 position-relative"
                style="min-height: 150px;">

                <!-- 1. Manual Input (Physical Scanner Mode) -->
                <div id="manual-input-area" class="p-4">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-secondary text-white border-secondary"><i
                                class="bi bi-upc-scan"></i></span>
                        <input type="text" id="resi-input"
                            class="form-control font-monospace text-center bg-dark text-white border-secondary"
                            placeholder="Scan Barcode Resi Disini..." autocomplete="off" style="caret-color: #0d6efd;">
                    </div>
                </div>

                <!-- 2. Local Reader Area (Client Camera) -->
                <!-- Use a slightly taller container for better local camera view -->
                <div id="local-reader-area" class="d-none text-center p-2">
                    <div id="reader-wrapper"
                        style="width: 100%; max-width: 400px; margin: 0 auto; border: 2px solid #555; border-radius: 8px; overflow: hidden; background: #000;">
                        <div id="html5-qrcode-reader"></div>
                    </div>
                </div>

                <!-- 3. Backend Scanner Preview (Server Camera) -->
                <div id="backend-scan-area"
                    class="d-none w-100 h-100 bg-black d-flex justify-content-center align-items-center"
                    style="min-height: 250px;">
                    <img id="backend-scan-feed" src="" class="img-fluid"
                        style="max-height: 300px; width: 100%; object-fit: contain;">
                </div>

                <!-- Scanning Visual Overlay (Shared) -->
                <div id="scan-visual-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none"
                    style="background: rgba(40, 167, 69, 0.1); border: 4px solid #28a745; z-index: 50; pointer-events: none;">
                </div>

            </div>
        </div>

        <!-- BOTTOM: RECORDING PREVIEW -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>3. Rekam Video (Bukti)</h5>
                <div id="recording-timer" class="h4 mb-0 font-monospace d-none">00:00</div>
            </div>

            <div id="camera-container" class="card-body p-0 position-relative bg-dark text-center"
                style="min-height: 480px; max-height: 550px; overflow: hidden; background-color: #000; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Camera Image -->
                <img id="camera-feed" src="" class="img-fluid"
                    style="max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: none;">

                <!-- Placeholder -->
                <div id="camera-placeholder"
                    class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center text-muted p-5 bg-dark">
                    <i class="fs-1 mb-3 bi bi-record-circle text-danger"></i>
                    <h4>Kamera Rekam Off</h4>
                    <p>Silakan hubungkan kamera rekam di menu sebelah kiri</p>
                </div>

                <!-- Recording Overlay (Responsive) -->
                <div id="recording-overlay"
                    class="position-absolute top-0 start-0 w-100 p-2 bg-danger text-white d-flex flex-column flex-md-row justify-content-between align-items-center gap-2 d-none"
                    style="z-index: 10;">
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-grow spinner-grow-sm text-white" role="status"></div>
                        <strong>SEDANG MEREKAM</strong>
                    </div>
                    <div class="font-monospace text-break small" id="rec-info">RESI...</div>
                </div>

                <!-- Zoom Controls -->
                <div id="zoom-container" class="zoom-controls d-none">
                    <button class="zoom-btn" onclick="adjustZoom(0.5)" title="Zoom In">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                        <i class="bi bi-aspect-ratio"></i>
                    </button>
                    <button class="zoom-btn" onclick="adjustZoom(-0.5)" title="Zoom Out">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                </div>
                <div id="zoom-indicator" class="zoom-info">Zoom: 1.0x</div>
            </div>

            <div class="card-footer">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
                    <div id="status-message" class="text-muted text-center text-md-start mb-2 mb-md-0">Siap merekam...
                    </div>
                    <div class="d-flex gap-2 w-100 w-md-auto justify-content-center">
                        <button id="btn-stop" class="btn btn-danger d-none flex-grow-1 flex-md-grow-0">
                            <i class="bi bi-check-circle-fill me-1"></i> Selesai & Simpan
                        </button>
                        <button id="btn-cancel" class="btn btn-outline-secondary d-none flex-grow-1 flex-md-grow-0">
                            <i class="bi bi-x-lg me-1"></i> Batal
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Recording Info -->
        <div class="card" id="last-recording-card" style="display: none;">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-success mb-1"><i class="bi bi-check-circle-fill me-1"></i> Rekaman Terakhir Disimpan
                    </h6>
                    <small id="last-record-detail" class="text-muted">RESI... â€¢ DURASI...</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-danger" onclick="redoRecording()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Redo (Rekam Ulang)
                    </button>
                    <button class="btn btn-sm text-white" id="btn-view-last" onclick="viewLastRecording()"
                        style="background-color: #FF6B35;">
                        <i class="bi bi-eye me-1"></i> Lihat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FAB Navigation -->
<!-- FAB Navigation (Always Visible) -->
<div class="fab-container">
    <!-- 1. Rekam (Bottom) -->
    <button class="fab-item" onclick="scrollToElement('camera-container')">
        <i class="bi bi-camera-video"></i>
        <span class="fab-tooltip">Ke Kamera Rekam</span>
    </button>

    <!-- 2. Scanner -->
    <button class="fab-item" onclick="scrollToElement('scanner-container')">
        <i class="bi bi-upc-scan"></i>
        <span class="fab-tooltip">Ke Scanner</span>
    </button>

    <!-- 3. Platform -->
    <button class="fab-item" onclick="scrollToElement('platform-card')">
        <i class="bi bi-grid"></i>
        <span class="fab-tooltip">Ke Platform</span>
    </button>

    <!-- 4. Atas (Top) - Conditional -->
    <button class="fab-item text-white" id="fab-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
        style="display: none; background-color: #FF6B35; border-color: #FF6B35;">
        <i class="bi bi-arrow-up"></i>
        <span class="fab-tooltip">Ke Atas</span>
    </button>
</div>

<!-- Video Modal (same as video gallery) -->
<div class="modal fade" id="videoModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-height: 90vh; margin: 5vh auto;">
        <div class="modal-content" style="max-height: 90vh; overflow: hidden;">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="modalVideoTitle">Pemutar Video</h5>
                    <p class="mb-0 text-muted small" id="modalVideoSubtitle">Detail rekaman</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <!-- Video Column -->
                    <div class="col-lg-8 bg-black d-flex align-items-center justify-content-center">
                        <video id="modalVideo" controls class="w-100" style="max-height: 70vh;" autoplay>
                            Browser Anda tidak mendukung tag video.
                        </video>
                        <div id="videoMissingOverlay" class="d-none text-center text-white">
                            <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                            <h5 class="mt-3">File Video Tidak Ditemukan</h5>
                            <p class="text-muted small">File fisik mungkin telah dihapus atau dipindahkan.</p>
                        </div>
                    </div>

                    <!-- Metadata Column -->
                    <div class="col-lg-4 p-4" style="max-height: 70vh; overflow-y: auto;">
                        <h6 class="text-uppercase text-muted mb-3 fw-bold">Informasi Paket</h6>

                        <div class="mb-4">
                            <label class="text-muted small">Nomor Resi</label>
                            <div class="fs-4 font-monospace fw-bold text-break" id="metaResi">-</div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="text-muted small">Platform</label>
                                <div id="metaPlatform" class="badge bg-secondary fs-6">-</div>
                            </div>
                            <div class="col-6">
                                <label class="text-muted small">Pegawai</label>
                                <div class="fw-bold" id="metaPegawai">-</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-muted small">Waktu Rekam</label>
                            <div id="metaTime">-</div>
                        </div>

                        <hr>

                        <h6 class="text-uppercase text-muted mb-3 fw-bold">File Metadata (JSON)</h6>
                        <pre id="metaJson" class="bg-light p-3 rounded small text-break border"
                            style="max-height: 200px; overflow: auto; font-size: 11px;">Memuat metadata...</pre>

                        <div class="d-grid gap-2 mt-4">
                            <a id="btnDownloadVideo" href="#" class="btn btn-primary" download>
                                <i class="bi bi-download me-2"></i>Unduh Video
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="{{ url_for('static', filename='vendor/html5-qrcode/html5-qrcode.min.js') }}"
    type="text/javascript"></script>
<script>
    // Configuration
    const SCAN_RATE = 700; // Barcode scan rate (ms) - quicker polling for easier detect
    const RECORDING_START_GRACE_PERIOD = 5000; // 5 seconds - don't stop immediately after start
    const BARCODE_COOLDOWN = 3000; // 3 seconds - cooldown between barcode detections

    let recordingCameraUrl = ''; // Replaces selectedCameraUrl
    let scanningCameraUrl = '';

    // Core state
    let selectedPlatform = '';
    let isRecording = false;
    let recordingId = null;
    let recordingStartTime = null;

    // Intervals
    let healthCheckInterval = null; // Renamed from previewInterval
    let barcodeLoopInterval = null; // New separate interval for barcode loop
    let timerInterval = null;
    let heartbeatInterval = null; // Pulse to keep camera alive

    // Scanner
    let html5QrCode = null; // Local scanner instance
    let isLocalScanActive = false; // Flag for local scanner state
    let lastBarcodeDetectTime = 0; // For cooldown
    let scanVisualEl = null; // Green scanning overlay

    // Other state
    let lastRecordId = null;
    let currentResi = null; // Track current resi being recorded
    let lastRecordingData = null; // Store last recording data for popup
    let currentZoom = 1.0;

    // UX Flags
    let hasScrolledToPlatform = false;

    // ==========================================
    // VOICE NOTIFICATION SYSTEM (Audio Files)
    // ==========================================

    // Voice notification settings (default OFF requested by user)
    let voiceNotificationEnabled = false;

    // Pre-load audio files for instant playback
    const voiceAudios = {
        'rekaman_dimulai': new Audio("{{ url_for('static', filename='assets/sounds/rekaman_dimulai.MP3') }}"),
        'menyimpan_rekaman': new Audio("{{ url_for('static', filename='assets/sounds/menyimpan_rekaman.MP3') }}"),
        'rekaman_selesai': new Audio("{{ url_for('static', filename='assets/sounds/rekaman_selesai.MP3') }}"),
        'rekaman_gagal': new Audio("{{ url_for('static', filename='assets/sounds/rekaman_gagal.MP3') }}")
    };

    // Set volume and debug handlers
    Object.keys(voiceAudios).forEach(key => {
        const audio = voiceAudios[key];
        audio.volume = 1.0; // Max volume
        audio.preload = 'auto';

        audio.addEventListener('error', (e) => {
            console.error(`Audio error for ${key}:`, e);
            console.error("Audio src:", audio.src);
        });

        audio.addEventListener('canplaythrough', () => {
            console.log(`Audio ready: ${key}`);
        });
    });

    // Function to play voice notification (INSTANT, NO DELAY)
    function speakText(key) {
        if (!voiceNotificationEnabled) return;

        const audio = voiceAudios[key];
        if (audio) {
            // Stop any currently playing voice
            Object.values(voiceAudios).forEach(a => {
                a.pause();
                a.currentTime = 0;
            });

            // Play immediately
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }
    }

    // Toggle voice notification
    function toggleVoiceNotification() {
        voiceNotificationEnabled = !voiceNotificationEnabled;

        // Save to localStorage
        localStorage.setItem('voiceNotificationEnabled', voiceNotificationEnabled);

        // Update UI
        updateVoiceToggleUI();

        // Feedback
        if (voiceNotificationEnabled) {
            Toast.fire({
                icon: 'success',
                title: 'Notifikasi Suara Aktif'
            });
            // Play sample
            setTimeout(() => speakText('rekaman_dimulai'), 300);
        } else {
            Toast.fire({
                icon: 'info',
                title: 'Notifikasi Suara Nonaktif'
            });
        }
    }

    // Update toggle button UI
    function updateVoiceToggleUI() {
        const btn = document.getElementById('btn-toggle-voice');
        if (!btn) return;

        if (voiceNotificationEnabled) {
            btn.innerHTML = '<i class="bi bi-volume-up-fill me-1"></i> Suara ON';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
        } else {
            btn.innerHTML = '<i class="bi bi-volume-mute-fill me-1"></i> Suara OFF';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }
    }

    // Load voice settings from localStorage
    function loadVoiceSettings() {
        const saved = localStorage.getItem('voiceNotificationEnabled');
        if (saved !== null) {
            voiceNotificationEnabled = saved === 'true';
        }
        updateVoiceToggleUI();
    }

    // ==========================================
    // JS HELPERS (UX)
    // ==========================================

    // Toast Notification
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000, // Reduced from 3000ms to 2000ms for faster UX
        timerProgressBar: true,
        background: '#1a1a2e',
        color: '#fff',
        didOpen: (toast) => {
            // Click to dismiss - prevent freeze
            toast.addEventListener('click', () => {
                Swal.close();
            });
            // Keep hover behavior for reading
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
        }
    });

    // Auto Scroll
    function scrollToElement(id) {
        const el = document.getElementById(id);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }



    // Sound effects
    const sounds = {
        beep: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Ik2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU='),
        success: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU='),
        error: new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU=')
    };

    // NEW: Scroll Listener for FAB Top Button
    window.addEventListener('scroll', function () {
        const fabTop = document.getElementById('fab-top');
        if (fabTop) {
            if (window.scrollY > 200) {
                // Show
                fabTop.style.display = 'flex';
                fabTop.style.setProperty('display', 'flex', 'important');
            } else {
                // Hide
                fabTop.style.display = 'none';
                fabTop.style.setProperty('display', 'none', 'important');
            }
        }
    });

    // ==========================================
    // SOUND ENGINE (AudioContext)
    // ==========================================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playTone(freq, type, duration, vol = 0.1) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function playSound(name) {
        try {
            switch (name) {
                // 1. Scan Berhasil (Idle/Start) -> "Tit"
                case 'start':
                case 'beep':
                    playTone(1500, 'sine', 0.1, 0.2);
                    break;

                // 2. Scan saat Recording -> "Tit" (Sama persis)
                case 'scan_warning':
                    playTone(1500, 'sine', 0.1, 0.2);
                    break;

                // 3. Recording START (Baru mulai rekam) -> "Blip-Blop" (Beda dari simpan)
                case 'record_start':
                    playTone(600, 'sine', 0.1, 0.2);
                    setTimeout(() => playTone(800, 'sine', 0.15, 0.2), 100);
                    break;

                // 3. Simpan Video -> "Chime" (Bukan tit)
                case 'save':
                case 'success':
                    playTone(523.25, 'sine', 0.2, 0.2); // C5
                    setTimeout(() => playTone(659.25, 'sine', 0.2, 0.2), 100); // E5
                    setTimeout(() => playTone(783.99, 'sine', 0.4, 0.2), 200); // G5
                    break;

                // Error
                case 'error':
                    playTone(150, 'sawtooth', 0.3, 0.2);
                    break;

                // Camera Connected -> "Ding-Dong" (Ascending chime)
                case 'camera_connected':
                    playTone(440, 'sine', 0.15, 0.15); // A4
                    setTimeout(() => playTone(554.37, 'sine', 0.25, 0.15), 120); // C#5
                    break;

                default:
                    playTone(440, 'sine', 0.1);
            }
        } catch (e) { console.error("Audio error:", e); }
    }

    // Toggle green overlay to show active scanning
    function setScanVisual(active) {
        if (!scanVisualEl) return;
        if (active) {
            scanVisualEl.classList.remove('d-none');
        } else {
            scanVisualEl.classList.add('d-none');
        }
    }

    // Helper: update camera usage purpose on server (preview/scan/record)
    function updateCameraUsage(purpose, specificUrl = null) {
        // Use specific URL if provided, otherwise default to selected (recorder)
        const targetUrl = specificUrl || selectedCameraUrl;

        if (!targetUrl || !purpose) return;

        console.log(`>>> [Mode] Setting ${purpose} for ${targetUrl}`);

        fetch('/api/camera/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: targetUrl, mode: purpose })
        }).catch(e => console.log('updateCameraMode failed', e));

        // Also call legacy usage endpoint for compatibility if needed
        // fetch('/api/camera/usage', ... 
    }

    // Getter alias for backward compatibility code
    Object.defineProperty(window, 'selectedCameraUrl', {
        get: function () { return recordingCameraUrl; },
        set: function (val) { recordingCameraUrl = val; }
    });

    document.addEventListener('DOMContentLoaded', function () {
        console.log(">>> [Recording Page] DOM Content Loaded");

        scanVisualEl = document.getElementById('scan-visual-overlay');
        setScanVisual(false);

        loadCameras();
        setupPlatformSelect();
        setupInputMethod();
        setupScannerInput();
        cleanupZombieRecording();

        // Load voice notification settings
        loadVoiceSettings();

        // Setup buttons
        document.getElementById('btn-stop').addEventListener('click', stopRecording);
        document.getElementById('btn-cancel').addEventListener('click', cancelRecording);

        // Wait for socket to be initialized before allowing barcode detection
        const waitForSocket = () => {
            // ... socket logic ...
            if (window.socket && window.socket.connected) {
                console.log(">>> [Recording Page] Socket is ready!");
            } else {
                setTimeout(waitForSocket, 500);
            }
        };
        waitForSocket();
    });

    // Zoom Functions
    function adjustZoom(delta) {
        if (!selectedCameraUrl) return;

        let newZoom = currentZoom + delta;
        if (newZoom < 1.0) newZoom = 1.0;
        if (newZoom > 4.0) newZoom = 4.0;

        if (newZoom === currentZoom) return;

        currentZoom = newZoom;
        sendZoomRequest();
    }

    function resetZoom() {
        if (!selectedCameraUrl) return;
        currentZoom = 1.0;
        sendZoomRequest();
    }

    function sendZoomRequest() {
        if (!selectedCameraUrl) return;

        const indicator = document.getElementById('zoom-indicator');
        if (currentZoom > 1.0) {
            indicator.style.display = 'block';
            indicator.textContent = `Zoom: ${currentZoom.toFixed(1)}x`;
        } else {
            indicator.style.display = 'none';
        }

        fetch('/api/camera/zoom', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: selectedCameraUrl,
                level: currentZoom
            })
        })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    console.error('Zoom failed:', data.message);
                }
            })
            .catch(err => console.error('Zoom error:', err));
    }



    // Prevent hanging on navigation
    // Combined cleanup handler
    function forceReleaseAll() {
        console.log(">>> [Lifecycle] Force releasing all cameras...");
        stopPreview(true);
        stopScanning(true);
    }

    window.addEventListener('beforeunload', function () {
        forceReleaseAll();
    });

    window.addEventListener('pagehide', function () {
        forceReleaseAll();
    });


    // Heartbeat System
    function startHeartbeat(url) {
        // [ANTIGRAVITY] HEARTBEAT DISABLED BY USER REQUEST
        console.log(">>> [Heartbeat] Disabled (Logic Removed)");
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            console.log(">>> [Heartbeat] Stopping");
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    function sendHeartbeat(url) {
        if (!url) return;
        fetch('/api/camera/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        }).then(res => {
            if (res.status === 404) {
                console.warn(">>> [Heartbeat] Server says camera closed. Force disconnect?");
                // Optional: Force UI disconnect if server killed it
            }
        }).catch(e => console.log('Heartbeat failed', e));
    }

    function stopPreview(force = false) {
        stopHeartbeat(); // Stop pulse immediately
        if (healthCheckInterval) clearInterval(healthCheckInterval);
        // DO NOT clear barcodeLoopInterval here. That belongs to the Scanner logic.
        // if (barcodeLoopInterval) clearTimeout(barcodeLoopInterval);

        const img = document.getElementById('camera-feed');
        if (img) {
            img.src = '';
            img.removeAttribute('src');
        }

        // Explicitly tell server to stop this camera stream
        // SHARED CAMERA FIX: Only release if NOT used by scanner
        if (selectedCameraUrl) {
            if (!force && selectedCameraUrl === scanningCameraUrl) {
                console.log(">>> [Preview] Skipping release: Camera shared with Scanner");
                return;
            }

            const data = JSON.stringify({ url: selectedCameraUrl });
            // Use sendBeacon for reliability during unload, or fetch if available
            if (navigator.sendBeacon) {
                const blob = new Blob([data], { type: 'application/json' });
                navigator.sendBeacon('/api/camera/release', blob);
            } else {
                fetch('/api/camera/release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: data
                }).catch(e => console.log('Release failed', e));
            }
        }
    }

    function closeAllCameras() {
        console.log('>>> [Close] Closing ALL connections');

        stopPreview(true);
        stopScanning(true);

        recordingCameraUrl = '';
        document.getElementById('camera-select-recording').value = '';

        scanningCameraUrl = '';
        document.getElementById('camera-select-scanning').value = '';

        // Reset connection buttons text
        document.getElementById('btn-connect-rec').innerHTML = '<i class="bi bi-play-fill"></i> Connect';
        document.getElementById('btn-connect-scan').innerHTML = '<i class="bi bi-play-fill"></i> Connect';

        selectedPlatform = '';
        const platformInput = document.getElementById('selected-platform');
        if (platformInput) platformInput.value = '';

        document.querySelectorAll('.platform-btn').forEach(b => {
            b.classList.remove('active', 'btn-success', 'btn-secondary');
            b.classList.add('btn-outline-secondary');
        });

        // Reset UI to initial state
        const img = document.getElementById('camera-feed');
        const placeholder = document.getElementById('camera-placeholder');
        const indicator = document.getElementById('camera-status-indicator');

        if (img) {
            img.style.display = 'none';
            img.classList.add('d-none');
        }

        if (placeholder) {
            placeholder.classList.remove('d-none');
            placeholder.classList.add('d-flex');
            placeholder.style.display = 'flex';
            placeholder.innerHTML = `
                <i class="fs-1 mb-3">ðŸ“·</i>
                <h4>Kamera Belum Aktif</h4>
                <p>Pilih kamera di sebelah kiri untuk memulai preview</p>
            `;
        }

        if (indicator) {
            indicator.innerHTML = 'Pilih kamera untuk cek status';
        }

        setScanVisual(false);

        // Hide scanner container
        const scannerContainer = document.getElementById('scanner-container');
        if (scannerContainer) scannerContainer.classList.add('d-none');

        // Hide zoom controls
        document.getElementById('zoom-container').classList.add('d-none');
        document.getElementById('zoom-indicator').style.display = 'none';
        currentZoom = 1.0;
    }


    // 1. Load Cameras
    function loadCameras() {
        const selectRec = document.getElementById('camera-select-recording');
        const selectScan = document.getElementById('camera-select-scanning');

        // Fetch from cache first for speed
        fetch('/api/cameras/status')
            .then(res => res.json())
            .then(data => {
                const statuses = data.status || {};

                // Then fetch full list
                return fetch('/api/cameras')
                    .then(res => res.json())
                    .then(configData => {
                        // Reset dropdowns
                        selectRec.innerHTML = '<option value="" disabled selected>Pilih kamera rekam...</option>';
                        selectScan.innerHTML = '<option value="" disabled selected>Pilih kamera scan...</option>';

                        // Add Local Client Camera option to Scan Dropdown
                        const localOption = document.createElement('option');
                        localOption.value = 'local_client_device';
                        localOption.text = 'ðŸ“± Local Camera (Client Device)';
                        localOption.style.fontWeight = 'bold';
                        selectScan.add(localOption);

                        const savedCamera = localStorage.getItem('last_camera_url');
                        let foundSaved = false;

                        const savedScanCamera = localStorage.getItem('last_scan_camera_url');
                        let foundSavedScan = false;

                        // Check if saved scan camera is local
                        if (savedScanCamera === 'local_client_device') {
                            localOption.selected = true;
                            scanningCameraUrl = 'local_client_device';
                            foundSavedScan = true;
                        }

                        selectScan.add(localOption); // Add local option first

                        (configData.cameras || []).forEach(cam => {
                            const status = Object.values(statuses).find(s => s.url === cam.url);
                            // const isOnline = status ? status.online : false; 
                            // Using name directly as provided in original code structure for now

                            // Rec Option
                            const optionRec = document.createElement('option');
                            optionRec.value = cam.url;
                            optionRec.text = `ðŸ“· ${cam.name}`;
                            selectRec.add(optionRec);

                            // Scan Option
                            const optionScan = document.createElement('option');
                            optionScan.value = cam.url;
                            optionScan.text = `ðŸ“· ${cam.name}`;

                            // Check for saved scan camera match
                            if (savedScanCamera && cam.url === savedScanCamera) {
                                optionScan.selected = true;
                                scanningCameraUrl = cam.url; // Set variable
                                foundSavedScan = true;
                            }

                            selectScan.add(optionScan);

                            if (savedCamera && cam.url === savedCamera) {
                                optionRec.selected = true;
                                foundSaved = true;
                            }
                        });

                        // Add "Add Camera" option to Recording
                        const addOption = document.createElement('option');
                        addOption.value = '__add_new__';
                        addOption.text = 'âž• Tambah Kamera Baru...';
                        addOption.style.fontWeight = 'bold';
                        addOption.style.color = '#0d6efd';
                        selectRec.add(addOption);

                        // Add "Add Camera" option to Scanning (CLONED for Scan)
                        const addOptionScan = document.createElement('option');
                        addOptionScan.value = '__add_new__';
                        addOptionScan.text = 'âž• Tambah Kamera Baru...';
                        addOptionScan.style.fontWeight = 'bold';
                        addOptionScan.style.color = '#0d6efd';
                        selectScan.add(addOptionScan);

                        // If saved selection found, activate it
                        if (foundSaved) {
                            // Don't auto-connect, let user click connect
                            recordingCameraUrl = savedCamera;
                        }
                    });
            });
    }

    // Handlers
    function handleRecordingCameraChange(url) {
        if (url === '__add_new__') {
            window.location.href = '/camera-settings';
            return;
        }

        // 1. Matikan kamera yang lagi dipakai (Stop OLD first)
        // We must stop BEFORE updating the variable, so stopPreview releases the correct URL
        stopPreview();

        // 2. Baru pindah ke kamera baru
        recordingCameraUrl = url;
        localStorage.setItem('last_camera_url', url);

        // RESET STATE (Ref: User request)
        resetScanningState();

        // Update button text to "Connect"
        const btn = document.getElementById('btn-connect-rec');
        if (btn) btn.innerHTML = '<i class="bi bi-play-fill"></i> Connect';

        checkReadyState();
    }

    function connectRecordingCamera() {
        if (!recordingCameraUrl) {
            alert("Pilih kamera rekam terlebih dahulu!");
            return;
        }

        // 1. Set Mode to RECORD (High FPS)
        updateCameraUsage('record', recordingCameraUrl);

        // CRITICAL FIX: Stop preview first to clear cache and reset state
        stopPreview();

        // Small delay to ensure cleanup completes
        setTimeout(() => {
            startPreview();

            // Change button to "Reload"
            const btn = document.getElementById('btn-connect-rec');
            if (btn) btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reload';
        }, 100);
    }

    function handleScanningCameraChange(url) {
        if (url === '__add_new__') {
            window.location.href = '/camera-settings';
            return;
        }

        // 1. Matikan kamera scan yang lagi dipakai
        stopScanning();

        // 2. Baru switch
        scanningCameraUrl = url;
        localStorage.setItem('last_scan_camera_url', url); // SAVE PREFERENCE

        // RESET STATE (Ref: User request)
        resetScanningState();

        const btn = document.getElementById('btn-connect-scan');
        if (btn) btn.innerHTML = '<i class="bi bi-play-fill"></i> Connect';

        checkReadyState();
    }

    function connectScanningCamera() {
        if (!scanningCameraUrl) {
            alert("Pilih kamera scan terlebih dahulu!");
            return;
        }

        // CRITICAL FIX: Stop scanning first to clear cache
        stopScanning();

        setTimeout(() => {
            startScanning();

            const btn = document.getElementById('btn-connect-scan');
            if (btn) btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reload';
        }, 100);
    }

    // Stop all scanning logic
    function stopScanning(force = false) {
        // 1. Stop Local
        isLocalScanActive = false;
        if (html5QrCode) {
            try {
                if (html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.log("Stop failed", err));
                }
            } catch (e) { console.log("Stop error", e); }
            html5QrCode = null;
        }

        // Hide All Areas first
        document.getElementById('local-reader-area').classList.add('d-none');
        document.getElementById('backend-scan-area').classList.add('d-none');
        // Do NOT unhide manual input here indiscriminately. Let setupInputMethod handle that.

        // Stop Backend Image feed
        const backendImg = document.getElementById('backend-scan-feed');
        if (backendImg) {
            backendImg.src = '';
            backendImg.removeAttribute('src');
        }

        // NEW: Explicitly release backend camera on server
        if (scanningCameraUrl && scanningCameraUrl !== 'local_client_device') {
            // SHARED CAMERA FIX: Only release if NOT used by recorder
            if (!force && scanningCameraUrl === recordingCameraUrl) {
                console.log(">>> [Scan] Skipping release: Camera shared with Recorder");
            } else {
                console.log('>>> [Scan] Releasing backend camera:', scanningCameraUrl);
                const data = JSON.stringify({ url: scanningCameraUrl });
                // [ANTIGRAVITY] Use sendBeacon if forcing (unload)
                if (force && navigator.sendBeacon) {
                    const blob = new Blob([data], { type: 'application/json' });
                    navigator.sendBeacon('/api/camera/release', blob);
                } else {
                    fetch('/api/camera/release', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        keepalive: true,
                        body: data
                    }).catch(e => console.log('Scan Release failed', e));
                }
            }
        }

        // 2. Stop Backend Loop
        if (barcodeLoopInterval) {
            clearTimeout(barcodeLoopInterval);
            barcodeLoopInterval = null;
        }

        checkReadyState(); // Update status on stop
    }

    // Start scanning logic
    function startScanning() {
        stopScanning(); // Clean slate

        // Clear Scan Error
        const errDiv = document.getElementById('scan-cam-error');
        if (errDiv) {
            errDiv.textContent = '';
            errDiv.classList.add('d-none');
        }
        // Reset Dropdown Error
        document.getElementById('camera-select-scanning').classList.remove('is-invalid');

        const container = document.getElementById('scanner-container');
        container.classList.remove('d-none'); // Top Card Body

        if (scanningCameraUrl === 'local_client_device') {
            console.log(">>> MUST START LOCAL SCANNING");
            // Show Local Reader UI
            document.getElementById('manual-input-area').classList.add('d-none');
            document.getElementById('backend-scan-area').classList.add('d-none');
            document.getElementById('local-reader-area').classList.remove('d-none');

            // Initialize Html5Qrcode
            // Use back camera
            html5QrCode = new Html5Qrcode("html5-qrcode-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            // CHECK SECURE CONTEXT
            if (window.isSecureContext === false) {
                alert("âš ï¸ Peringatan: Browser Anda memblokir akses kamera karena koneksi tidak aman (HTTP). \n\nSolusi:\n1. Gunakan HTTPS jika tersedia.\n2. Atau buka chrome://flags di HP, cari 'Insecure origins treated as secure', lalu enable dan masukkan IP server ini.");
            }

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => {
                    isLocalScanActive = true;
                    Toast.fire({
                        icon: 'success',
                        title: 'Kamera Scan Terhubung'
                    });
                    playSound('camera_connected');
                    checkReadyState(); // Update status immediately
                })
                .catch(err => {
                    console.log("Local camera start failed", err);
                    let msg = "Gagal membuka kamera lokal.";
                    if (err?.toString().includes("is not supported")) {
                        msg = "Browser ini tidak mendukung streaming kamera (HTTP).";
                    } else if (err?.name === "NotAllowedError") {
                        msg = "Izin kamera ditolak.";
                    }

                    // Show in specific error box
                    const errDiv = document.getElementById('scan-cam-error');
                    if (errDiv) {
                        errDiv.innerHTML = `<small class="text-danger fw-bold"><i class="bi bi-exclamation-triangle me-1"></i> ${msg}</small>`;
                        errDiv.classList.remove('d-none');
                        errDiv.classList.add('d-block');
                    }
                    // Highlight Dropdown
                    // Highlight Dropdown
                    document.getElementById('camera-select-scanning').classList.add('is-invalid');
                });

        } else {
            console.log(">>> MUST START BACKEND SCANNING for", scanningCameraUrl);
            // Backend Scanning
            document.getElementById('local-reader-area').classList.add('d-none');
            document.getElementById('manual-input-area').classList.add('d-none');

            // Show Backend Feed
            const backendArea = document.getElementById('backend-scan-area');
            backendArea.classList.remove('d-none');
            // Ensure container has relative styling for absolute positioning of loader if needed, 
            // and min-height to prevent zero-height collapse
            backendArea.style.position = 'relative';
            backendArea.style.minHeight = '240px';
            backendArea.style.backgroundColor = '#000'; // Black background for video area

            const feedImg = document.getElementById('backend-scan-feed');

            // Reset image visibility to ensure clean load state
            feedImg.style.display = 'none';
            feedImg.classList.add('d-none');
            // Clear src to stop previous stream if any
            feedImg.removeAttribute('src');

            // Find or create 'loading' overlay within the area
            let loadingText = document.getElementById('scan-loading-text');
            if (!loadingText) {
                loadingText = document.createElement('div');
                loadingText.id = 'scan-loading-text';
                loadingText.className = 'd-flex justify-content-center align-items-center flex-column text-info';
                loadingText.style.position = 'absolute';
                loadingText.style.top = '0';
                loadingText.style.left = '0';
                loadingText.style.width = '100%';
                loadingText.style.height = '100%';
                loadingText.style.zIndex = '10';
                loadingText.innerHTML = `
                    <div class="spinner-border mb-2" role="status" style="width: 2rem; height: 2rem;"></div>
                    <span>Menghubungkan kamera scan...</span>
                `;
                backendArea.appendChild(loadingText);
            }
            // Ensure visual reset
            loadingText.style.display = 'flex';
            loadingText.style.setProperty('display', 'flex', 'important');
            loadingText.innerHTML = `
                <div class="spinner-border mb-2" role="status" style="width: 2rem; height: 2rem;"></div>
                <span>Menghubungkan kamera scan...</span>
            `;

            feedImg.onload = function () {
                console.log('>>> [Scan] Backend camera loaded');
                feedImg.style.display = 'block';
                feedImg.classList.remove('d-none');

                // Force hide the loading text overlay
                const loader = document.getElementById('scan-loading-text');
                if (loader) {
                    loader.style.display = 'none';
                    loader.style.setProperty('display', 'none', 'important');
                }

                // UX: Toast for Scanner
                Toast.fire({
                    icon: 'success',
                    title: 'Kamera Scan Terhubung'
                });

                // Play camera connected sound
                playSound('camera_connected');

                // RESTORE SCANNING STATE IF PLATFORM SELECTED
                if (selectedPlatform) {
                    const indicator = document.getElementById('camera-status-indicator');
                    if (indicator) indicator.innerHTML = '<span class="text-primary">Silakan scan resi...</span>';
                    updateStatus(`Platform ${selectedPlatform} aktif. Silakan scan resi.`);
                    if (scanningCameraUrl && scanningCameraUrl !== 'local_client_device') {
                        updateCameraUsage('scan', scanningCameraUrl);
                    }
                }
            };

            // CRITICAL: Error handler with retry logic
            let scanRetryCount = 0;
            const scanMaxRetries = 3;

            feedImg.onerror = function () {
                console.log('>>> [Scan] Image load error triggered');

                if (scanRetryCount < scanMaxRetries) {
                    scanRetryCount++;
                    console.log(`>>> [Scan] Retrying connection (${scanRetryCount}/${scanMaxRetries})...`);

                    // Update loading text to show retry
                    const loader = document.getElementById('scan-loading-text');
                    if (loader) {
                        loader.innerHTML = `
                            <div class="spinner-border mb-2 text-info" role="status" style="width: 2rem; height: 2rem;"></div>
                            <span>Menghubungkan...</span>
                        `;
                    }

                    // Try reload with delay
                    setTimeout(() => {
                        feedImg.src = `/video_feed?url=${encodeURIComponent(scanningCameraUrl)}&type=scan&t=${Date.now()}`;
                    }, 1500);
                } else {
                    // Failed after retries
                    console.error('>>> [Scan] Failed to connect after retries');

                    const loader = document.getElementById('scan-loading-text');
                    if (loader) {
                        loader.innerHTML = `
                            <i class="fs-1 mb-3 text-danger">âš ï¸</i>
                            <h5 class="text-danger">Koneksi Gagal</h5>
                            <p class="text-light">Kamera scan tidak merespon</p>
                            <button class="btn btn-primary mt-2" onclick="connectScanningCamera()">ðŸ”„ Coba Lagi</button>
                        `;
                    }

                    // Show error in feedback area
                    const errDiv = document.getElementById('scan-cam-error');
                    if (errDiv) {
                        errDiv.innerHTML = '<small class="text-danger fw-bold"><i class="bi bi-exclamation-circle me-1"></i> Gagal terhubung ke kamera scan. Cek koneksi.</small>';
                        errDiv.classList.remove('d-none');
                        errDiv.classList.add('d-block');
                    }

                    document.getElementById('camera-select-scanning').classList.add('is-invalid');
                }
            };

            // Set stream source with cache buster
            feedImg.src = `/video_feed?url=${encodeURIComponent(scanningCameraUrl)}&type=scan&t=${new Date().getTime()}`;

            // Watchdog: Force timeout if image doesn't load in 8 seconds
            let scanLoadSuccess = false;

            // Mark success when onload fires
            const originalOnload = feedImg.onload;
            feedImg.onload = function () {
                scanLoadSuccess = true;
                if (originalOnload) originalOnload.call(this);
            };

            setTimeout(() => {
                if (!scanLoadSuccess) {
                    console.warn('>>> [Scan] Watchdog timeout - forcing error');
                    // Manually trigger error handler
                    const loader = document.getElementById('scan-loading-text');
                    if (loader) {
                        loader.innerHTML = `
                            <i class="fs-1 mb-3 text-danger">âš ï¸</i>
                            <h5 class="text-danger">Timeout</h5>
                            <p class="text-light">Kamera scan tidak merespon dalam 8 detik</p>
                            <button class="btn btn-primary mt-2" onclick="connectScanningCamera()">ðŸ”„ Coba Lagi</button>
                        `;
                    }

                    const errDiv = document.getElementById('scan-cam-error');
                    if (errDiv) {
                        errDiv.innerHTML = '<small class="text-danger fw-bold"><i class="bi bi-exclamation-circle me-1"></i> Timeout. Kamera tidak merespon.</small>';
                        errDiv.classList.remove('d-none');
                        errDiv.classList.add('d-block');
                    }

                    document.getElementById('camera-select-scanning').classList.add('is-invalid');
                }
            }, 8000);

            startBarcodeLoop();
        }

        // Give a moment for elements to update classes then check
        setTimeout(checkReadyState, 500);
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Code matched = ${decodedText}`, decodedResult);
        handleResiDetected(decodedText);
    }


    // Global connection state
    let isConnecting = false;

    // 2. Camera Preview (Persistent Stream)
    // NOTE: This now only handles RECORDING camera preview
    function startPreview() {
        if (!recordingCameraUrl) return;

        selectedCameraUrl = recordingCameraUrl; // Sync for compatibility

        console.log('>>> [Preview] Starting preview for:', recordingCameraUrl);

        // Clear any existing timeout
        if (healthCheckInterval) clearInterval(healthCheckInterval);

        const img = document.getElementById('camera-feed');
        const placeholder = document.getElementById('camera-placeholder');
        const indicator = document.getElementById('camera-status-indicator');

        // Safety Clean
        img.onload = null;
        img.onerror = null;

        // Clear error
        const errDiv = document.getElementById('rec-cam-error');
        if (errDiv) {
            errDiv.textContent = '';
            errDiv.classList.add('d-none');
            errDiv.classList.remove('d-block');
        }
        // Reset Dropdown Error
        document.getElementById('camera-select-recording').classList.remove('is-invalid');


        // Set initial connecting status
        isConnecting = true; // LOCK PLATFORM SELECTION
        if (indicator) {
            indicator.innerHTML = '<span class="text-info">ðŸ”µ Menghubungkan...</span>';
        }
        updateStatus('Menghubungkan ke kamera...');

        // Reset state: Hide placeholder, show image container (but image itself might take a moment)
        img.classList.remove('d-none');
        img.style.display = 'block';

        placeholder.classList.remove('d-flex');
        placeholder.classList.add('d-none');
        placeholder.style.display = 'none'; // Doubletap

        // NEW: Add temporary loading overlay for Recording Camera Container
        const container = document.getElementById('camera-container'); // This is the parent div
        let loadingOverlay = document.getElementById('rec-loading-overlay');

        // Ensure container is relative for absolute positioning AND has height
        if (container) {
            container.style.position = 'relative';
            // CRITICAL FIX: Set min-height so the container doesn't collapse when the image is hidden!
            // Assuming standard video aspect ratio or fixed UI height
            container.style.minHeight = '480px';
            container.style.backgroundColor = '#000';
        }

        // HIDE IMAGE INITIALLY to show loader
        img.style.display = 'none';
        img.classList.add('d-none');

        if (!loadingOverlay && container) {
            loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'rec-loading-overlay';
            loadingOverlay.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center';
            loadingOverlay.style.zIndex = '200'; // Even Higher z-index to be safe
            loadingOverlay.style.backgroundColor = 'rgba(0,0,0,1)'; // Solid black

            loadingOverlay.innerHTML = `
                <div class="spinner-border text-white mb-3" role="status" style="width: 3rem; height: 3rem; border-width: 4px;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-white mt-2">Menghubungkan...</h5>
                <p class="text-white-50 small">Menunggu stream dari server</p>
            `;
            container.appendChild(loadingOverlay);
        } else if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.classList.remove('d-none');
            // Ensure content is fresh
            loadingOverlay.innerHTML = `
                <div class="spinner-border text-white mb-3" role="status" style="width: 3rem; height: 3rem; border-width: 4px;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-white mt-2">Menghubungkan...</h5>
                <p class="text-white-50 small">Menunggu stream dari server</p>
            `;
        }



        // Setup stream monitoring
        // Helper to show disconnect UI
        const showDisconnectUI = () => {
            isConnecting = false; // RELEASE LOCK (to allow retry or other actions)
            if (loadingOverlay) loadingOverlay.style.display = 'none';


            const indicator = document.getElementById('camera-status-indicator');
            const img = document.getElementById('camera-feed');
            const placeholder = document.getElementById('camera-placeholder');

            // Explicitly HIDE overlay if it exists
            const overlay = document.getElementById('rec-loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.style.setProperty('display', 'none', 'important');
            }

            // Update status
            // indicator.innerHTML = '<span class="text-danger">ðŸ”´ Kamera Terputus</span>';
            indicator.innerHTML = '<span class="text-danger">âš ï¸ Koneksi Gagal</span>';

            // LOCKDOWN: Clear platform
            selectedPlatform = '';
            const platformInput = document.getElementById('selected-platform');
            if (platformInput) platformInput.value = '';

            // Reset buttons UI
            document.querySelectorAll('.platform-btn').forEach(b => {
                b.classList.remove('active', 'btn-success', 'btn-secondary'); // comprehensive clear
                b.classList.add('btn-outline-secondary');
            });

            // Update Reset Button Visibility
            updateResetButtonVisibility();

            // Hide image
            if (img) {
                img.style.display = 'none';
                img.classList.add('d-none');
                img.removeAttribute('src'); // Stop browser from trying to load
            }



            updateStatus('Kamera terputus. Silakan hubungkan ulang.');

            checkReadyState(); // Update Ready Text (will clear 'Siap merekam')

            // Show placeholder with retry
            placeholder.classList.remove('d-none');
            placeholder.classList.add('d-flex');
            placeholder.style.display = 'flex'; // Force flex display
            placeholder.innerHTML = `
                <i class="fs-1 mb-3 text-danger">âš ï¸</i>
                <h4 class="text-danger">Koneksi Terputus</h4>
                <p>Kamera tidak merespon atau koneksi hilang.</p>
                <div class="d-flex flex-column gap-2 mt-2">
                    <button class="btn btn-primary" onclick="startPreview()">ðŸ”„ Hubungkan Ulang</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="closeAllCameras()">âŒ Tutup Semua</button>
                </div>
            `;
        };

        // Track if connection succeeded to prevent premature error display
        let connectionSucceeded = false;

        img.onload = function () {
            connectionSucceeded = true;
            isConnecting = false; // UNLOCK PLATFORM SELECTION

            // Explicitly find overlay again to be sure
            const overlay = document.getElementById('rec-loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.style.setProperty('display', 'none', 'important');
            }

            // SHOW IMAGE NOW
            this.style.display = 'block';
            this.classList.remove('d-none');

            console.log('>>> [Preview] Camera connected successfully');

            // UX Connection Toast
            if (!isRecording) {
                Toast.fire({
                    icon: 'success',
                    title: 'Kamera Terhubung'
                });

                // Play camera connected sound
                playSound('camera_connected');
            }

            // UPDATED: Prompt logic based on Input Method
            const indicator = document.getElementById('camera-status-indicator');
            const currentMethod = document.querySelector('input[name="input-method"]:checked')?.value;

            if (!selectedPlatform) {
                if (currentMethod === 'camera') {
                    // Defer to checkBarcode() loop which enforces "Both Cameras" rule
                    indicator.innerHTML = '<span class="text-info">â„¹ï¸ Hubungkan Kamera Scan untuk lanjut...</span>';
                    updateStatus('Kamera rekam terhubung. Menunggu kamera scanner.');
                } else {
                    // Manual/Local mode: Prompt immediately
                    indicator.innerHTML = '<span class="text-warning" style="font-weight: bold; font-size: 1.1em;">âš ï¸ Silakan Pilih Platform (Langkah 2)</span>';
                    updateStatus('Kamera terhubung. Silakan pilih platform.');
                }
            } else {
                indicator.innerHTML = '<span class="text-success">ðŸŸ¢ Kamera Online</span>';
                updateStatus('Siap merekam. Silakan scan resi.');
            }


            // Ensure placeholder is gone
            placeholder.classList.add('d-none');
            placeholder.classList.remove('d-flex');
            placeholder.style.setProperty('display', 'none', 'important');

            // RESTORE SCANNING STATE IF PLATFORM SELECTED
            if (selectedPlatform) {
                if (indicator) indicator.innerHTML = '<span class="text-primary">Silakan scan resi...</span>';
                updateStatus(`Platform ${selectedPlatform} aktif. Silakan scan resi.`);
                updateCameraUsage('scan');
            }


            // Camera is online, check visibility
            updateResetButtonVisibility();

            // Show zoom controls
            document.getElementById('zoom-container').classList.remove('d-none');
            resetZoom(); // Ensure backend & frontend are synced to 1.0

            // Mark usage as preview when stream is up
            updateCameraUsage('preview');

            // CRITICAL FIX: Ensure scanner input is visible if scanner mode is selected
            const inputMethod = document.querySelector('input[name="input-method"]:checked');
            if (inputMethod && inputMethod.value === 'scanner') {
                const scannerContainer = document.getElementById('scanner-container');
                if (scannerContainer) {
                    scannerContainer.classList.remove('d-none');
                    // Auto-focus the input
                    setTimeout(() => {
                        const resiInput = document.getElementById('resi-input');
                        if (resiInput) resiInput.focus();
                    }, 100);
                }
            }

            checkReadyState(); // Update Ready Text
        };

        // CRITICAL: Error handler with retry logic (from camera.html)
        let retryCount = 0;
        const maxRetries = 3;

        img.onerror = function () {
            console.log('>>> [Preview] Image load error triggered');
            connectionSucceeded = false;

            if (retryCount < maxRetries) {
                retryCount++;
                console.log(`>>> [Preview] Retrying connection (${retryCount}/${maxRetries})...`);

                // Update loading overlay to show retry
                const overlay = document.getElementById('rec-loading-overlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div class="spinner-border text-white mb-3" role="status" style="width: 3rem; height: 3rem; border-width: 4px;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="text-white mt-2">Menghubungkan...</h5>
                        <p class="text-white-50 small">Menunggu stream dari server</p>
                    `;
                }

                // Try reload with delay
                setTimeout(() => {
                    img.src = `/video_feed?url=${encodeURIComponent(recordingCameraUrl)}&t=${Date.now()}`;
                }, 1500);
            } else {
                isConnecting = false;
                showDisconnectUI();
            }
        };

        // Set stream source with cache buster
        img.src = `/video_feed?url=${encodeURIComponent(recordingCameraUrl)}&t=${new Date().getTime()}`;

        // Set mode to PREVIEW by default when starting camera
        updateCameraUsage('preview', recordingCameraUrl);

        // START HEARTBEAT
        startHeartbeat(recordingCameraUrl);

        // Timeout check: if still "Menghubungkan" after 8s
        setTimeout(() => {
            // Updated Watchdog: Strict 8s limit
            if (!connectionSucceeded) {
                console.warn(">>> [Preview] Watchdog Timeout: Connection took too long.");
                isConnecting = false;
                showDisconnectUI();

                // Extra error feedback
                const indicator = document.getElementById('camera-status-indicator');
                if (indicator) {
                    indicator.innerHTML = '<span class="text-danger">âš ï¸ Timeout. Gagal terhubung (Cek Server).</span>';
                }
            }
        }, 8000); // 8 seconds limit
    }

    function startBarcodeLoop() {
        console.log(">>> startBarcodeLoop() called (STRICT GATED MODE)");
        if (barcodeLoopInterval) clearTimeout(barcodeLoopInterval);

        // Wait for socket to be initialized
        const currentSocket = window.socket;
        if (!currentSocket) {
            console.warn(">>> [Loop] Socket not initialized yet, retrying in 500ms...");
            barcodeLoopInterval = setTimeout(startBarcodeLoop, 500);
            return;
        }

        // Check if socket is connected
        if (!currentSocket.connected) {
            console.warn(">>> [Loop] Socket not connected yet, retrying in 500ms...");
            barcodeLoopInterval = setTimeout(startBarcodeLoop, 500);
            return;
        }

        console.log(">>> [Loop] Socket ready! Starting barcode detection loop...");

        let isWaitingForResponse = false; // This variable is now managed by the server response
        let lastRequestTime = 0;

        // Listen for socket results
        currentSocket.off('barcode_result');
        currentSocket.on('barcode_result', (data) => {
            console.log(">>> [Loop] Barcode result received:", data);
            isWaitingForResponse = false; // Reset gate on response
            setScanVisual(false);
            const indicator = document.getElementById('camera-status-indicator');
            if (data.success && data.found) {
                console.log(">>> BARCODE FOUND:", data.barcodes[0].data);
                if (indicator) indicator.innerHTML = '<span class="text-success">âœ… Resi Ditemukan!</span>';
                handleResiDetected(data.barcodes[0].data);
            }
        });

        // Listen for camera errors (Immediate Disconnect)
        currentSocket.off('camera_error');
        currentSocket.on('camera_error', (data) => {
            console.warn(">>> [Socket] Camera Error Event:", data);

            // Check Recording Camera
            if (recordingCameraUrl && data.url === recordingCameraUrl) {
                console.log(">>> [Socket] Triggering disconnect for Recording Camera");
                isConnecting = false; // Stop spinner
                showDisconnectUI();

                const indicator = document.getElementById('camera-status-indicator');
                if (indicator) indicator.innerHTML = '<span class="text-danger">âš ï¸ Koneksi Terputus (Server Error).</span>';
            }
            // Check Scanning Camera? (Optional, maybe just log for now)
            if (scanningCameraUrl && data.url === scanningCameraUrl) {
                console.log(">>> [Socket] Triggering disconnect for Scanner Camera");
                // Handle scanner disconnect if needed (not implementing full UI for scanner yet, just status)
            }
        });

        // Listen for ping test
        currentSocket.off('pong_test');
        currentSocket.on('pong_test', (data) => {
            console.log(">>> [Socket] PONG RECEIVED:", data.message);
        });

        const checkBarcode = () => {
            const inputMethod = document.querySelector('input[name="input-method"]:checked')?.value;
            const indicator = document.getElementById('camera-status-indicator');
            const imgEl = document.getElementById('camera-feed');
            // STRICT CHECK: Match checkReadyState logic (Src + Not Connecting)
            const isCameraVisible = imgEl && !imgEl.classList.contains('d-none') && (imgEl.style.display !== 'none') && imgEl.getAttribute('src') && !isConnecting;

            // 1. Basic checks
            if (!scanningCameraUrl || inputMethod !== 'camera') {
                // If not in camera mode or no scanning camera selected, stop
                barcodeLoopInterval = setTimeout(checkBarcode, 1000);
                return;
            }

            // Only proceed if scanning camera is NOT local
            if (scanningCameraUrl === 'local_client_device') return;

            if (!selectedPlatform) {
                isWaitingForResponse = false;
                setScanVisual(false);

                // Update zoom indicator visibility
                const zInd = document.getElementById('zoom-indicator');
                if (isCameraVisible && currentZoom > 1.0) {
                    zInd.style.display = 'block';
                    zInd.textContent = `Zoom: ${currentZoom.toFixed(1)}x`;
                } else {
                    zInd.style.display = 'none';
                }

                // Only show "Pilih Platform" if camera is VISIBLE (Online) AND NOT CONNECTING
                // This prevents overwriting the disconnect error message

                // STRICT CHECK: Both Scanner AND Recorder must be online
                const scanFeed = document.getElementById('backend-scan-feed');
                const isScanActive = scanFeed && !scanFeed.classList.contains('d-none') && scanFeed.getAttribute('src');

                if (!selectedPlatform && inputMethod === 'camera' && selectedCameraUrl && isCameraVisible && isScanActive && !isConnecting) {
                    if (indicator && !indicator.innerText.includes('Pilih Platform')) {
                        indicator.innerHTML = '<span class="text-warning">âš ï¸ Pilih Platform untuk mulai scan resi otomatis</span>';
                    }
                }
                barcodeLoopInterval = setTimeout(checkBarcode, 1000);
                return;
            }

            // check connection
            if (!currentSocket.connected) {
                console.warn(">>> [Loop] Socket Disconnected, waiting...");
                if (indicator) {
                    indicator.innerHTML = '<span class="text-danger">ðŸ”´ Socket disconnected</span>';
                }
                setScanVisual(false);
                barcodeLoopInterval = setTimeout(checkBarcode, 1000);
                return;
            }

            // 2. Strict Gating - Prevent flooding the server
            const now = Date.now();
            if (isWaitingForResponse) {
                if (now - lastRequestTime > 5000) { // Timeout for response
                    console.warn(">>> [Loop] Request timed out, resetting gate");
                    isWaitingForResponse = false;
                } else {
                    setScanVisual(true);
                    barcodeLoopInterval = setTimeout(checkBarcode, 200); // Check again soon
                    return;
                }
            }

            // 3. Perform Scan using Optimized Backend
            // Server will now try: Original -> Grayscale -> Contrast -> Threshold
            if (indicator) {
                if (isRecording) {
                    if (!indicator.innerText.includes('Scanning')) {
                        indicator.innerHTML = '<span class="text-danger">ðŸ”´ Recording Active (Scan to Stop)</span>';
                    }
                } else if (!indicator.innerText.includes('Silakan')) {
                    indicator.innerHTML = '<span class="text-primary">ðŸ” Silakan scan resi... (Memindai)</span>';
                }
            }

            // Run a ping test once every 10 seconds to verify line is hot
            if (now % 10000 < 1000) {
                // console.log(">>> [Loop] Sending ping test...");
                currentSocket.emit('ping_test', { time: now });
            }

            isWaitingForResponse = true;
            lastRequestTime = now;
            // console.log(">>> [Loop] Emitting detect_barcode (Optimized Mode) for URL:", scanningCameraUrl);
            setScanVisual(true);
            currentSocket.emit('detect_barcode', { url: scanningCameraUrl });

            // Re-schedule based on SCAN_RATE
            barcodeLoopInterval = setTimeout(checkBarcode, SCAN_RATE);
        };

        checkBarcode();
    }

    // NEW: Helper to toggle visibility of Stop Camera Scanning button
    function updateResetButtonVisibility() {
        const btn = document.getElementById('btn-reset-scanning');
        if (!btn) return;

        const inputMethod = document.querySelector('input[name="input-method"]:checked')?.value;
        const img = document.getElementById('camera-feed');
        // Check if camera image is visible (meaning connected)
        const isCameraActive = img && !img.classList.contains('d-none') && (img.style.display !== 'none');

        // Only show if Input Method is Camera AND Camera is Active AND Platform is Selected
        if (inputMethod === 'camera' && isCameraActive && selectedPlatform) {
            btn.classList.remove('d-none');
        } else {
            btn.classList.add('d-none');
        }
    }

    // NEW: Manual Reset State
    // NEW: Manual Reset State
    function resetScanningState() {
        console.log('>>> [Reset] Manual reset triggered');

        // 1. Reset Platform (Keep Camera Alive)


        // 2. Reset Platform
        selectedPlatform = '';
        const platformInput = document.getElementById('selected-platform');
        if (platformInput) platformInput.value = '';

        // 3. Reset UI Buttons
        document.querySelectorAll('.platform-btn').forEach(b => {
            b.classList.remove('active', 'btn-success', 'btn-secondary');
            b.classList.add('btn-outline-secondary');
        });

        // 4. Reset UI to Idle State - REMOVED to keep camera active
        // Only update message
        if (!isRecording) {
            const indicator = document.getElementById('camera-status-indicator');
            // Check if camera is still technically "online" in UI
            const img = document.getElementById('camera-feed');

            // Check visibility AND src presence
            const isRecCamActive = img && !img.classList.contains('d-none') && img.style.display !== 'none' && img.getAttribute('src');

            if (indicator) {
                if (isRecCamActive) {
                    indicator.innerHTML = '<span class="text-warning" style="font-weight: bold; font-size: 1.1em;">âš ï¸ Silakan Pilih Platform (Langkah 2)</span>';
                } else {
                    indicator.innerHTML = '<span class="text-info">â„¹ï¸ Hubungkan Kamera Rekam untuk lanjut...</span>';
                }
            }
        }

        updateStatus('Scanning dihentikan.');

        // Update usage back to preview (kamera hanya preview, tidak scan)
        updateCameraUsage('preview');

        // 5. Update Visibility (will hide the button)
        updateResetButtonVisibility();
    }

    // 3. Platform Selection
    function setupPlatformSelect() {
        document.querySelectorAll('.platform-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Check if currently connecting
                if (isConnecting) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Tunggu Sebentar',
                        text: 'Kamera sedang menghubungkan... Harap tunggu hingga kamera online.',
                        confirmButtonColor: '#ff6b35'
                    });
                    return;
                }

                // 1. VALIDASI: Pastikan kamera connect sebelum pilih platform
                // Gunakan checkReadyState untuk validasi ketat
                const isReady = checkReadyState(true); // pass true to get boolean only? No, we check the global state or re-verify.
                // Let's manually verify requirements here for the specific error message

                const inputMethod = document.querySelector('input[name="input-method"]:checked').value;
                const recActive = recordingCameraUrl && document.getElementById('camera-feed').src && !document.getElementById('camera-feed').classList.contains('d-none');

                // For scanning, if mode is camera, we need it.
                // NOTE: Local camera might not have a 'src' on backend-scan-feed, but uses html5-qrcode
                let scanActive = false;
                if (inputMethod === 'camera') {
                    if (scanningCameraUrl === 'local_client_device') {
                        scanActive = html5QrCode && html5QrCode.isScanning;
                    } else if (scanningCameraUrl) {
                        scanActive = document.getElementById('backend-scan-feed').src && !document.getElementById('backend-scan-area').classList.contains('d-none');
                    }
                } else {
                    scanActive = true; // Ignore scan camera in manual/scanner mode
                }

                if (!recActive) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kamera Belum Siap',
                        text: 'Pastikan Kamera Perekam sudah dipilih dan Connected (Layar tampil).',
                        confirmButtonColor: '#ff6b35'
                    });
                    return;
                }

                if (inputMethod === 'camera' && !scanActive) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kamera Scan Belum Siap',
                        text: 'Di mode "Deteksi Kamera", pastikan Kamera Scanner sudah dipilih dan Connected.',
                        confirmButtonColor: '#ff6b35'
                    });
                    return;
                }

                // Deselect others
                document.querySelectorAll('.platform-btn').forEach(b => {
                    b.classList.remove('active', 'btn-secondary');
                    b.classList.add('btn-outline-secondary');
                });

                // Select this
                this.classList.remove('btn-outline-secondary');
                this.classList.add('active', 'btn-secondary');

                selectedPlatform = this.dataset.platform;
                document.getElementById('selected-platform').value = selectedPlatform;

                // Focus scanner input if in scanner mode
                if (document.querySelector('input[name="input-method"]:checked').value === 'scanner') {
                    document.getElementById('resi-input').focus();
                }

                updateStatus(`Platform ${selectedPlatform} dipilih. Silakan scan resi.`);

                // Update indicator text explicitly as requested
                const indicator = document.getElementById('camera-status-indicator');
                if (indicator) indicator.innerHTML = '<span class="text-primary">Silakan scan resi...</span>';

                // Show Stop Scanning button
                updateResetButtonVisibility();

                checkReadyState(); // Update "Siap Merekam" text

                // Mark usage as scan (baik deteksi kamera maupun metode input resi manual)
                if (selectedCameraUrl) {
                    updateCameraUsage('scan');
                }

                // FORCE LOOP RESTART
                // Ensure the loop is running in case it was stopped or died
                startBarcodeLoop();

                // UX: Scroll to Scanner Area
                scrollToElement('scanner-container');
            });
        });
    }

    // 4. Input Method Handling
    function setupInputMethod() {
        const radios = document.querySelectorAll('input[name="input-method"]');

        const handleInputMethodChange = () => {
            const selected = document.querySelector('input[name="input-method"]:checked');
            const scanRow = document.getElementById('scan-camera-row');

            // Areas
            const manualArea = document.getElementById('manual-input-area');
            const localArea = document.getElementById('local-reader-area');
            const backendArea = document.getElementById('backend-scan-area');

            if (selected && selected.value === 'scanner') {
                // MANUAL SCANNER MODE
                // Show Scan Camera dropdown? No, hide it
                if (scanRow) scanRow.style.display = 'none';

                // Visible: Manual Input
                if (manualArea) manualArea.classList.remove('d-none');

                // Hidden: Camera feeds
                if (localArea) localArea.classList.add('d-none');
                if (backendArea) backendArea.classList.add('d-none');

                // Focus
                setTimeout(() => {
                    const input = document.getElementById('resi-input');
                    if (input) input.focus();
                }, 50);

                // Stop any automated scanning
                stopScanning();

            } else {
                // CAMERA SCAN/DETECT MODE
                // Show Scan Camera dropdown
                if (scanRow) scanRow.style.display = 'block';

                // HIDE Manual Input (Users request)
                if (manualArea) manualArea.classList.add('d-none');

                // Note: We don't auto-show camera feeds here, we wait for "Connect" button
            }

            // Update button visibility based on method change
            updateResetButtonVisibility();
        };

        radios.forEach(radio => {
            radio.addEventListener('change', handleInputMethodChange);
        });

        // Initialize state on load
        handleInputMethodChange();
        checkReadyState();
    }

    // 5. Scanner logic
    function setupScannerInput() {
        const input = document.getElementById('resi-input');

        // STRICT Auto-focus keep alive
        input.addEventListener('blur', function (e) {
            // Check if we are still in scanner mode
            const inputMethod = document.querySelector('input[name="input-method"]:checked');
            if (!inputMethod || inputMethod.value !== 'scanner') return;

            // Allow interaction with specific UI elements without stealing focus back immediately
            // e.relatedTarget is the element that received focus
            if (e.relatedTarget) {
                const tag = e.relatedTarget.tagName;
                const id = e.relatedTarget.id;

                // Allow clicking buttons, links, selects, and other inputs
                if (tag === 'BUTTON' || tag === 'A' || tag === 'SELECT' || tag === 'INPUT' || tag === 'TEXTAREA') {
                    return;
                }
            }

            // If we clicked on blank space or something irrelevant, force focus back
            setTimeout(() => {
                // Double check active element is not something useful
                const active = document.activeElement;
                if (!active || active === document.body || active === input) {
                    this.focus();
                }
            }, 100);
        });

        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const resi = this.value.trim();
                if (resi) {
                    handleResiDetected(resi);
                    this.value = ''; // Clear
                }
            }
        });
    }

    // Camera Barcode Detection


    // 6. Main Logic: Handle Resi
    function handleResiDetected(resi) {
        const now = Date.now();

        // Check cooldown to prevent rapid re-scans
        if (now - lastBarcodeDetectTime < BARCODE_COOLDOWN) {
            console.log(`>>> [Barcode] Cooldown active, ignoring scan (${Math.round((BARCODE_COOLDOWN - (now - lastBarcodeDetectTime)) / 1000)}s remaining)`);
            return;
        }

        if (isRecording) {
            // SMART AUTO-STOP: Check if same resi is scanned again
            if (resi === currentResi) {
                const recordingDuration = now - recordingStartTime.getTime();

                // Grace period: Don't stop immediately after start (prevent accidental double-scan)
                if (recordingDuration < RECORDING_START_GRACE_PERIOD) {
                    console.log(`>>> [Recording] Grace period active, ignoring stop request (${Math.round((RECORDING_START_GRACE_PERIOD - recordingDuration) / 1000)}s remaining)`);
                    playSound('beep'); // Just beep, don't stop
                    return;
                }

                // Auto-stop recording
                console.log(`>>> [Recording] Same barcode detected! Auto-stopping recording...`);
                playSound('beep'); // "Tit" (Confirm Scan 2)
                lastBarcodeDetectTime = now;
                stopRecording();
                return;
            } else {
                // Different resi scanned while recording - SHOW VALIDATION ERROR
                console.log(`>>> [Recording] Different barcode detected while recording, showing error`);
                playSound('error');
                speakText('rekaman_gagal'); // Use available audio file


                // Update status with clear error message
                updateStatus(`âŒ Resi tidak cocok! Scan "${currentResi}" untuk stop atau klik tombol Stop.`);

                // Show visual feedback in camera status indicator
                const indicator = document.getElementById('camera-status-indicator');
                if (indicator) {
                    indicator.innerHTML = `
                        <span class="text-danger fw-bold">
                            âš ï¸ RESI TIDAK COCOK!<br>
                            <small>Diharapkan: <code class="text-warning">${currentResi}</code></small><br>
                            <small>Terdeteksi: <code class="text-danger">${resi}</code></small>
                        </span>
                    `;

                    // Reset indicator after 5 seconds
                    setTimeout(() => {
                        if (isRecording && indicator) {
                            indicator.innerHTML = '<span class="text-danger">ðŸ”´ Recording Active (Scan to Stop)</span>';
                        }
                    }, 5000);
                }

                // Prominent alert for emphasis
                Swal.fire({
                    icon: 'error',
                    title: 'RESI TIDAK COCOK!',
                    background: '#0a0a12',
                    color: '#ffffff',
                    html: `
                        <div class="text-start">
                            <p>Anda sedang merekam resi: <br><strong>${currentResi}</strong></p>
                            <p>Tapi yang baru saja di-scan: <br><strong class="text-danger">${resi}</strong></p>
                            <hr>
                            <p class="mb-0 small text-muted">Silakan scan ulang resi <strong>${currentResi}</strong> untuk menghentikan rekaman ini, atau klik tombol "Stop & Simpan".</p>
                        </div>
                    `,
                    confirmButtonText: 'Saya Mengerti',
                    confirmButtonColor: '#ff6b35'
                });

                return;
            }
        }

        if (!selectedPlatform) {
            playSound('error');
            speakText('rekaman_gagal'); // Platform not selected
            Swal.fire({
                icon: 'warning',
                title: 'Platform Belum Dipilih',
                text: 'Harap pilih platform terlebih dahulu sebelum melakukan scanning!',
                confirmButtonColor: '#ff6b35',
                background: '#0a0a12',
                color: '#ffffff'
            });
            return;
        }

        if (!selectedCameraUrl) {
            playSound('error');
            speakText('rekaman_gagal'); // Camera not connected

            Swal.fire({
                icon: 'warning',
                title: 'Kamera Belum Dipilih',
                text: 'Harap hubungkan kamera yang aktif terlebih dahulu!',
                confirmButtonColor: '#ff6b35',
                background: '#0a0a12',
                color: '#ffffff'
            });
            return;
        }

        // Start Recording
        playSound('beep');
        lastBarcodeDetectTime = now;
        currentResi = resi; // Save current resi
        startRecording(resi, selectedPlatform);
    }

    function startRecording(resi, platform) {
        updateStatus('â³ Memulai rekaman...');

        // Force RECORD mode (High FPS)
        updateCameraUsage('record');

        fetch('/api/recording/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                resi: resi,
                platform: platform,
                camera_url: selectedCameraUrl
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    recordingId = data.recording_id;  // Changed from data.id
                    isRecording = true;
                    recordingStartTime = new Date();

                    // Update UI
                    // document.getElementById('scanner-overlay').classList.remove('d-flex'); // REMOVED
                    // document.getElementById('scanner-overlay').classList.add('d-none');    // REMOVED

                    document.getElementById('recording-overlay').classList.remove('d-none');
                    document.getElementById('recording-overlay').classList.add('d-flex');

                    document.getElementById('rec-info').textContent = `${resi} / ${platform}`;

                    document.getElementById('btn-stop').classList.remove('d-none');
                    document.getElementById('btn-cancel').classList.remove('d-none');

                    document.getElementById('recording-timer').classList.remove('d-none');

                    // Start Timer
                    startTimer();

                    updateStatus(`ðŸ”´ Merekam ${resi}... (Scan lagi untuk stop)`);

                    // UX Improvements
                    scrollToElement('camera-container');

                    // Show prominent toast notification when recording starts
                    Toast.fire({
                        icon: 'success',
                        title: 'ðŸŽ¥ Rekaman Dimulai!',
                        text: `Merekam: ${resi} (${platform})`
                    });

                    playSound('record_start'); // Success sound when recording starts

                    // Voice notification
                    speakText('rekaman_dimulai');

                } else {
                    playSound('error');

                    // Voice notification for error
                    speakText('rekaman_gagal');

                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Memulai Rekaman',
                        text: data.error,
                        confirmButtonColor: '#d33',
                        background: '#0a0a12',
                        color: '#ffffff'
                    });
                    updateStatus('âŒ Gagal: ' + data.error);
                }
            })
            .catch(err => {
                playSound('error');
                speakText('rekaman_gagal');
                alert('Error: ' + err);
            });
    }

    function stopRecording() {
        console.log(">>> [UI] Stop button clicked. ID:", recordingId);
        if (!recordingId) {
            console.error(">>> [UI] Error: No recordingId found!");
            return;
        }

        // Validation: Check duration > 3s
        const duration = (new Date() - recordingStartTime) / 1000;
        if (duration < 3) {
            if (!confirm('Rekaman kurang dari 3 detik. Yakin ingin menyimpan?')) {
                return;
            }
        }

        updateStatus('ðŸ’¾ Menyimpan rekaman...');
        Toast.fire({
            title: 'ðŸ”ƒ Menyimpan Rekaman',
        });


        // Voice notification
        speakText('menyimpan_rekaman');

        fetch('/api/recording/stop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recording_id: recordingId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    try {
                        // Success Feedback FIRST
                        updateStatus('âœ… Rekaman disimpan!');

                        // UX Improvements
                        scrollToElement('scanner-container');

                        // Show success toast with details
                        Toast.fire({
                            icon: 'success',
                            title: 'ðŸ’¾ Rekaman Disimpan!',
                            text: `${currentResi || '-'} (${selectedPlatform || '-'})`
                        });

                        playSound('success');

                        // Voice notification
                        speakText('rekaman_selesai'); // Changed from 'rekaman_disimpan'

                        lastRecordId = recordingId; // Save ID for redo
                        currentResi = null;

                        // Prepare popup data
                        // Check if elements exist to prevent errors
                        const recInfoEl = document.getElementById('rec-info');
                        const rawInfo = recInfoEl ? recInfoEl.textContent : '';
                        const parts = rawInfo.split(' / ');

                        lastRecordingData = {
                            url: data.video_url || '#',
                            resi: parts[0] || 'Unknown',
                            platform: parts[1] || selectedPlatform || 'Unknown',
                            pegawai: '{{ current_user.username }}',
                            time: new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Jakarta' }).replace(' ', ' '),
                            json: data.video_url ? data.video_url.replace('.mp4', '.json') : '#',
                            file_exists: data.file_exists
                        };

                        // CRITICAL: Reset recording state
                        isRecording = false;
                        recordingId = null;

                        resetUI();

                        // Show last record info
                        const lastCard = document.getElementById('last-recording-card');
                        if (lastCard) {
                            lastCard.style.display = 'flex';
                            document.getElementById('last-record-detail').textContent = rawInfo;
                            // document.getElementById('last-record-link').href = data.video_url || '#'; // REMOVED: Element does not exist
                        }

                        // If scanner mode, refocus
                        const inputMethod = document.querySelector('input[name="input-method"]:checked');
                        if (inputMethod && inputMethod.value === 'scanner') {
                            const resiInput = document.getElementById('resi-input');
                            if (resiInput) resiInput.focus();
                            // Overlay logic removed, container stays visible
                        }

                        // CLEAR ERROR MESSAGES: Reset camera indicator to ready state
                        const indicator = document.getElementById('camera-status-indicator');
                        if (indicator && selectedPlatform) {
                            indicator.innerHTML = '<span class="text-primary">ðŸ” Silakan scan resi...</span>';
                        }
                    } catch (e) {
                        console.error("UI Update Error:", e);
                        updateStatus('âœ… Disimpan (UI Error)');
                        resetUI(); // Force reset
                    }

                } else {
                    playSound('error');

                    // Voice notification for save error
                    speakText('rekaman_gagal');

                    alert('Gagal stop: ' + data.error);
                }
            })
            .catch(err => {
                console.error(">>> [UI] Stop fetch error:", err);
                alert("Gagal menghubungi server: " + err.message);
            });
    }

    // Reset UI helper
    function resetUI() {
        // Hide recording overlay
        const recOverlay = document.getElementById('recording-overlay');
        if (recOverlay) {
            recOverlay.classList.remove('d-flex');
            recOverlay.classList.add('d-none');
        }

        // Hide buttons
        document.getElementById('btn-stop')?.classList.add('d-none');
        document.getElementById('btn-cancel')?.classList.add('d-none');
        document.getElementById('recording-timer')?.classList.add('d-none');

        // Stop timer
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // Restore PREVIEW mode (Low FPS)
        updateCameraUsage('preview');
    }

    function cancelRecording() {
        console.log(">>> [UI] Cancel button clicked. ID:", recordingId);
        if (!recordingId) return;

        if (!confirm('Yakin ingin membatalkan rekaman ini? File tidak akan disimpan.')) return;

        fetch('/api/recording/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recording_id: recordingId })
        })
            .then(res => res.json())
            .then(data => {
                // CRITICAL: Reset recording state
                isRecording = false;
                recordingId = null;
                currentResi = null;

                resetUI();
                updateStatus('âŒ Rekaman dibatalkan');

                // Show cancel toast notification
                Toast.fire({
                    icon: 'warning',
                    title: 'ðŸ—‘ï¸ Rekaman Dibatalkan',
                    text: 'Video tidak disimpan'
                });

                // Voice notification
                speakText('rekaman_gagal'); // No specific 'cancelled' audio, use 'gagal'

                // Restore scanner if needed
                if (document.querySelector('input[name="input-method"]:checked').value === 'scanner') {
                    document.getElementById('resi-input').focus();
                }
            })
            .catch(err => {
                console.error(">>> [UI] Cancel fetch error:", err);
                alert("Gagal membatalkan: " + err.message);
            });
    }

    function redoRecording() {
        if (!lastRecordId) return;
        if (!confirm('PERINGATAN: Rekaman sebelumnya akan DIHAPUS dan Anda akan merekam ulang resi yang sama. Lanjutkan?')) return;

        // Delete previous
        fetch('/api/recording/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recording_id: lastRecordId })
        })
            .then(res => res.json())
            .then(() => {
                document.getElementById('last-recording-card').style.display = 'none';
                lastRecordId = null;
                updateStatus('â™»ï¸ Siap rekam ulang. Silakan scan/input resi lagi.');
                document.getElementById('resi-input').focus();
            });
    }

    // Utils
    function startTimer() {
        const timerEl = document.getElementById('recording-timer');
        clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const diff = Math.floor((new Date() - recordingStartTime) / 1000);
            const min = Math.floor(diff / 60).toString().padStart(2, '0');
            const sec = (diff % 60).toString().padStart(2, '0');
            timerEl.textContent = `${min}:${sec}`;

            // Color coding based on validation
            timerEl.classList.remove('text-success', 'text-warning', 'text-danger');

            if (diff < 180) { // < 3 min
                timerEl.classList.add('text-success');
            } else if (diff < 270) { // 3 - 4.5 min
                timerEl.classList.add('text-warning');
            } else { // > 4.5 min
                timerEl.classList.add('text-danger');
            }

            // Auto check
            if (diff >= 300) { // 5 min max
                stopRecording(); // Auto stop/split logic could go here
            }

        }, 1000);
    }

    function resetUI() {
        isRecording = false;
        recordingId = null;
        clearInterval(timerInterval);

        document.getElementById('recording-overlay').classList.add('d-none');
        document.getElementById('recording-overlay').classList.remove('d-flex');

        document.getElementById('btn-stop').classList.add('d-none');
        document.getElementById('btn-cancel').classList.add('d-none');

        document.getElementById('recording-timer').classList.add('d-none');
        document.getElementById('recording-timer').textContent = '00:00';
    }

    function updateStatus(msg) {
        document.getElementById('status-message').textContent = msg;
    }

    function cleanupZombieRecording() {
        // DO NOT RESUME. CLEAN UP instead. (Requested by user)
        fetch('/api/recordings/active')
            .then(res => res.json())
            .then(data => {
                if (data.active) {
                    console.warn(`[Cleanup] Found zombie recording ${data.recording_id}. Cancelling...`);
                    // Cancel it silently (reuse cancel logic if possible, or direct fetch)
                    if (data.recording_id) {
                        const payload = JSON.stringify({ recording_id: data.recording_id });
                        fetch('/api/recording/cancel', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: payload
                        }).catch(e => console.log('Cleanup error', e));
                    }
                } else {
                    console.log("[Cleanup] No zombie recordings found.");
                }
            })
            .catch(err => console.log("[Cleanup] Check failed (server might be offline)", err));
    }

    // NEW: Centralized Ready State Check
    function checkReadyState() {
        const inputMethod = document.querySelector('input[name="input-method"]:checked')?.value;
        const msgEl = document.getElementById('status-message');
        const indicator = document.getElementById('camera-status-indicator');

        // 1. Cek Recording Camera
        const recImg = document.getElementById('camera-feed');
        // Ensure src is present AND we are not in the middle of connecting (spinning)
        // AND Button text says "Reload" (meaning we are active)
        const btnRec = document.getElementById('btn-connect-rec');
        const isRecBtnActive = btnRec && btnRec.innerHTML.includes('Reload');

        const recConnected = recordingCameraUrl && recImg && !recImg.classList.contains('d-none') &&
            recImg.style.display !== 'none' && recImg.getAttribute('src') &&
            !isConnecting && isRecBtnActive;

        // 2. Cek Scanning Camera (Only if inputMethod == 'camera')
        let scanConnected = true; // Default true for 'scanner' mode (manual)
        if (inputMethod === 'camera') {
            if (scanningCameraUrl === 'local_client_device') {
                scanConnected = isLocalScanActive;
            } else if (scanningCameraUrl) {
                const scanImg = document.getElementById('backend-scan-feed');
                scanConnected = scanImg && scanImg.src && !scanImg.parentElement.classList.contains('d-none');
            } else {
                scanConnected = false;
            }
        }

        let headerStatus = "";
        let isReady = false;

        // Logic display
        if (!inputMethod) return;

        if (inputMethod === 'scanner') {
            if (recConnected) {
                // Ready
                isReady = true;
                headerStatus = "Siap merekam...";
            } else {
                headerStatus = "Hubungkan Kamera Perekam...";
            }
        } else {
            // Camera detection mode
            if (recConnected && scanConnected) {
                isReady = true;
                headerStatus = "Siap deteksi & rekam...";
            } else {
                if (!recConnected && !scanConnected) headerStatus = "Hubungkan kedua kamera...";
                else if (!recConnected) headerStatus = "Hubungkan kamera rekam...";
                else headerStatus = "Hubungkan kamera scan...";
            }
        }

        // UPDATE INDICATOR (Top Status)
        // Fix for "Stuck" text when local camera connects
        if (indicator && !isRecording) {
            if (isReady) {
                if (!selectedPlatform) {
                    indicator.innerHTML = '<span class="text-warning" style="font-weight: bold; font-size: 1.1em;">âš ï¸ Silakan Pilih Platform (Langkah 2)</span>';
                } else {
                    indicator.innerHTML = '<span class="text-primary">Silakan scan resi...</span>';
                }
            } else {
                // Not Ready
                if (!recConnected) {
                    indicator.innerHTML = '<span class="text-info">â„¹ï¸ Hubungkan Kamera Rekam untuk lanjut...</span>';
                } else if (!scanConnected && inputMethod === 'camera') {
                    indicator.innerHTML = '<span class="text-info">â„¹ï¸ Hubungkan Kamera Scan untuk lanjut...</span>';
                }
            }
        }

        // Update Text (Bottom Status)
        if (!isRecording) { // Don't overwrite if recording
            // Clean "ready" text if not connected
            if (isReady) {
                // Determine message style
                if (selectedPlatform) {
                    msgEl.textContent = headerStatus;
                    msgEl.classList.remove('text-muted');
                    msgEl.classList.add('text-success');
                } else {
                    // Cameras ready but waiting for platform
                    msgEl.textContent = headerStatus; // "Siap deteksi & rekam..."
                    msgEl.classList.remove('text-success');
                    msgEl.classList.add('text-muted');
                }

                // UX: Auto-scroll to Platform if not yet done and NO platform selected
                if (!hasScrolledToPlatform && !selectedPlatform) {
                    console.log(">>> Auto-scrolling to Platform Selection");
                    scrollToElement('platform-card');
                    hasScrolledToPlatform = true;
                }

            } else {
                // If not ready, remove "Siap merekam" text (hide or show instruction)
                msgEl.textContent = headerStatus;
                msgEl.classList.remove('text-success');
                msgEl.classList.add('text-muted');

                // Reset scroll flag if connections dropped
                if (!recConnected || !scanConnected) {
                    hasScrolledToPlatform = false;
                }
            }
        }

        // NEW: Update Scan Status Badge
        const badge = document.getElementById('scan-status-badge');
        if (badge) {
            if (isReady && selectedPlatform) {
                badge.classList.remove('d-none', 'bg-secondary', 'bg-warning');
                badge.classList.add('bg-primary');
                badge.textContent = 'Ready';
            } else if (inputMethod === 'camera' && !scanConnected) {
                // Camera selected but not connected
                badge.classList.remove('d-none', 'bg-primary', 'bg-success');
                badge.classList.add('bg-secondary');
                badge.textContent = 'Off';
            } else {
                // Not ready for other reasons
                badge.classList.add('d-none');
            }
        }

        return isReady;
    }

    // Auto-cancel on page unload (Refresh, Close, Navigate Away)
    window.addEventListener('beforeunload', function (e) {
        if (isRecording && recordingId) {
            const data = JSON.stringify({ recording_id: recordingId });
            // Use Blob with explicit type so backend can parse it or fallback to text
            const blob = new Blob([data], { type: 'application/json' });
            navigator.sendBeacon('/api/recording/cancel', blob);
            console.log(">> beacon sent for cancel");
        }
    });

    // View last recording in popup
    function viewLastRecording() {
        if (lastRecordingData) {
            openVideoModal(lastRecordingData);
        } else {
            alert('Tidak ada rekaman terakhir');
        }
    }



</script>
<script src="{{ url_for('static', filename='js/modules/video_player.js') }}"></script>
{% endblock %}