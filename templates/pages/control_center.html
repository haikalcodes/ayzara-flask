{% extends "base.html" %}

{% block title %}Control Center - AYZARA Dashboard{% endblock %}

{% block content %}
<style>
    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .camera-card {
        border: 3px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s;
        position: relative;
    }

    .camera-card.status-idle {
        border-color: #6c757d;
    }

    .camera-card.status-recording {
        border-color: #dc3545;
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
        animation: pulse-red 1.5s infinite;
    }

    .camera-card.status-completed {
        border-color: #28a745;
    }

    .camera-card.status-error {
        border-color: #ffc107;
    }

    @keyframes pulse-red {

        0%,
        100% {
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
        }

        50% {
            box-shadow: 0 0 30px rgba(220, 53, 69, 0.8);
        }
    }

    .camera-header {
        padding: 15px;
        font-weight: bold;
        font-size: 1.3rem;
        text-align: center;
        color: white;
    }

    .camera-header.status-idle {
        background: #6c757d;
    }

    .camera-header.status-recording {
        background: #dc3545;
    }

    .camera-header.status-completed {
        background: #28a745;
    }

    .camera-header.status-error {
        background: #ffc107;
        color: #000;
    }

    .camera-feed-container {
        position: relative;
        background: #000;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .camera-feed-container img {
        width: 100%;
        height: auto;
        display: block;
    }

    .status-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
        font-size: 0.9rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
    }

    .camera-info {
        padding: 15px;
        background: #f8f9fa;
    }

    .camera-info .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .camera-info .info-label {
        font-weight: bold;
        color: #6c757d;
    }

    .last-barcode {
        font-family: monospace;
        font-size: 1.1rem;
        color: #0d6efd;
    }
</style>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-grid-3x3-gap"></i> Control Center</h1>
                <p class="text-muted">Monitor semua kamera secara real-time</p>
            </div>
            <div>
                <a href="/setup-stations" class="btn btn-outline-secondary">
                    <i class="bi bi-gear"></i> Setup
                </a>
                <button class="btn btn-danger" onclick="emergencyStopAll()">
                    <i class="bi bi-stop-circle"></i> Emergency Stop All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Session Summary -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h5 id="total-cameras">0</h5>
                        <small class="text-muted">Total Kamera</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="idle-count" class="text-secondary">0</h5>
                        <small class="text-muted">Idle</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="recording-count" class="text-danger">0</h5>
                        <small class="text-muted">Recording</small>
                    </div>
                    <div class="col-md-3">
                        <h5 id="completed-count" class="text-success">0</h5>
                        <small class="text-muted">Completed Today</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Camera Grid -->
<div class="camera-grid" id="camera-grid">
    <div class="text-center text-muted p-5">
        <i class="bi bi-camera-video-off fs-1"></i>
        <p>Memuat kamera...</p>
    </div>
</div>

<!-- Audio Manager -->
<audio id="audio-scan-success"
    src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU="
    preload="auto"></audio>
<audio id="audio-recording-start"
    src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU="
    preload="auto"></audio>
<audio id="audio-recording-stop"
    src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU="
    preload="auto"></audio>
<audio id="audio-error"
    src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQUrgs7y2Yk2CBlou+3mn00QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBBChRet+vrqFUUCkaf4PK+bCEFK4LO8tmJNggZaLvt5p9NEAxQp+PwtmMcBjiS1/LLeSsFJHfH8N2QQAoUXrfr66hVFApGn+DyvmwhBSuCzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF636+uoVRQKRp/g8r5sIQU="
    preload="auto"></audio>

<script>
    let cameras = [];
    let audioEnabled = true;
    let scanInterval = null;
    let refreshInterval = null;
    let activeVideoFeeds = {}; // Track active img elements

    document.addEventListener('DOMContentLoaded', function () {
        loadCameras();

        // Refresh status every 2 seconds
        refreshInterval = setInterval(loadCameras, 2000);

        // Start barcode scanning loop
        // Start barcode scanning loop
        startScanningLoop();
    });

    function loadCameras() {
        fetch('/api/session/status')
            .then(res => res.json())
            .then(data => {
                if (data.session) {
                    // Convert cameras dict to list
                    const cameraList = Object.entries(data.session.cameras).map(([url, info]) => ({
                        camera_url: url,
                        ...info
                    }));

                    // Detect if camera list changed significantly to avoid full re-render
                    const newCameraUrls = cameraList.map(c => c.camera_url).sort().join(',');
                    const currentCameraUrls = cameras.map(c => c.camera_url).sort().join(',');

                    cameras = cameraList;

                    if (newCameraUrls !== currentCameraUrls) {
                        renderCameraGrid();
                    } else {
                        // Just update statuses if grid exists
                        updateCameraStatuses();
                    }

                    // Update summary from backend data
                    if (data.summary) {
                        document.getElementById('total-cameras').textContent = data.summary.total_cameras || 0;
                        document.getElementById('idle-count').textContent = data.summary.idle || 0;
                        document.getElementById('recording-count').textContent = data.summary.recording || 0;
                        document.getElementById('completed-count').textContent = data.summary.completed || 0;
                    }
                } else {
                    // No active session
                    document.getElementById('camera-grid').innerHTML = `
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-camera-video-off fs-1"></i>
                            <p>Tidak ada sesi aktif. Silakan setup di <a href="/setup-stations">Setup Stations</a></p>
                        </div>
                    `;
                }
            })
            .catch(err => console.error('Error loading cameras:', err));
    }

    function renderCameraGrid() {
        const grid = document.getElementById('camera-grid');
        activeVideoFeeds = {}; // Reset tracking

        if (cameras.length === 0) {
            grid.innerHTML = `
                <div class="text-center text-muted p-5">
                    <i class="bi bi-camera-video-off fs-1"></i>
                    <p>Tidak ada kamera aktif. Silakan setup di <a href="/setup-stations">Setup Stations</a></p>
                </div>
            `;
            return;
        }

        grid.innerHTML = '';

        cameras.forEach(camera => {
            const card = createCameraCard(camera);
            grid.appendChild(card);

            // Track image element for scanning
            const imgId = `feed-${btoa(camera.camera_url).replace(/=/g, '')}`;
            activeVideoFeeds[camera.camera_url] = imgId;
        });
    }

    function updateCameraStatuses() {
        cameras.forEach(camera => {
            const statusText = {
                'idle': 'SIAP',
                'scanning': 'SCANNING...',
                'recording': 'MEREKAM',
                'completed': 'SELESAI',
                'error': 'ERROR'
            }[camera.status] || 'UNKNOWN';

            const cardId = `camera-${btoa(camera.camera_url).replace(/=/g, '')}`; // Safe ID
            const card = document.getElementById(cardId);

            if (card) {
                // Update classes
                card.className = `camera-card status-${camera.status}`;

                // Update header
                const header = card.querySelector('.camera-header');
                if (header) header.className = `camera-header status-${camera.status}`;

                // Update overlay text
                const overlay = card.querySelector('.status-overlay');
                if (overlay) overlay.textContent = statusText;

                // Update Barcode info
                const barcodeEl = card.querySelector('.last-barcode');
                if (barcodeEl) barcodeEl.textContent = camera.last_barcode || '-';

                // Update Error info
                const errorContainer = card.querySelector('.error-container');
                if (camera.error_message) {
                    if (errorContainer) {
                        errorContainer.innerHTML = `
                            <div class="info-row">
                                <span class="info-label text-danger">Error:</span>
                                <span class="text-danger">${camera.error_message}</span>
                            </div>`;
                    }
                } else if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }
        });
    }

    function stopRecordingManually(cameraUrl, safeId) {
        // Disable button to prevent double click
        const card = document.getElementById(`camera-${safeId}`);
        if (card) {
            const btn = card.querySelector('.btn-danger');
            if (btn) btn.disabled = true;
        }

        fetch('/api/session/stop-recording', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ camera_url: cameraUrl })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // UI update via socket/poll
                    loadCameras();
                } else {
                    Swal.fire('Gagal', data.message, 'error');
                    if (card) {
                        const btn = card.querySelector('.btn-danger');
                        if (btn) btn.disabled = false;
                    }
                }
            })
            .catch(err => console.error(err));
    }

    function cancelRecordingManually(cameraUrl, safeId) {
        if (!confirm("Yakin ingin MEMBATALKAN rekaman ini? Video tidak akan disimpan.")) return;

        const card = document.getElementById(`camera-${safeId}`);
        if (card) {
            const btn = card.querySelector('.btn-outline-secondary');
            if (btn) btn.disabled = true;
        }

        fetch('/api/session/cancel-recording', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ camera_url: cameraUrl })
        })
            .then(res => res.json())
            .then(data => {
                loadCameras();
            })
            .catch(err => console.error(err));
    }

    function createCameraCard(camera) {
        const card = document.createElement('div');
        card.className = `camera-card status-${camera.status}`;
        const safeId = btoa(camera.camera_url).replace(/=/g, '');
        card.id = `camera-${safeId}`;

        const statusText = {
            'idle': 'SIAP',
            'scanning': 'SCANNING...',
            'recording': 'MEREKAM',
            'completed': 'SELESAI',
            'error': 'ERROR'
        }[camera.status] || 'UNKNOWN';

        const feedId = `feed-${safeId}`;
        const feedUrl = `/video_feed?url=${encodeURIComponent(camera.camera_url)}&t=${Date.now()}`;

        card.innerHTML = `
            <div class="camera-header status-${camera.status}">
                <i class="bi bi-person-circle"></i> ${camera.employee_name}
            </div>
            <div class="camera-feed-container">
                <img src="${feedUrl}" id="${feedId}" alt="Camera Feed" crossorigin="anonymous"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22240%22%3E%3Crect fill=%22%23222%22 width=%22320%22 height=%22240%22/%3E%3Ctext fill=%22%23fff%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Signal%3C/text%3E%3C/svg%3E'">
                <div class="status-overlay">${statusText}</div>
            </div>
            <div class="camera-info">
                <div class="info-row">
                    <span class="info-label">Platform:</span>
                    <span class="badge bg-secondary">${camera.platform}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Barcode:</span>
                    <span class="last-barcode">${camera.last_barcode || '-'}</span>
                </div>
                
                ${camera.status === 'recording' ? `
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-danger btn-sm flex-grow-1" onclick="stopRecordingManually('${camera.camera_url}', '${safeId}')">
                        <i class="bi bi-stop-circle"></i> STOP (Save)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="cancelRecordingManually('${camera.camera_url}', '${safeId}')" title="Batalkan & Hapus">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                ` : ''}

                <div class="error-container">
                    ${camera.error_message ? `
                    <div class="info-row">
                        <span class="info-label text-danger">Error:</span>
                        <span class="text-danger">${camera.error_message}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        return card;
    }

    // Hidden canvas for processing frames
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // Round-Robin Scanning Logic
    let currentCameraIndex = 0;
    let isScanning = false;

    function startScanningLoop() {
        if (scanInterval) clearTimeout(scanInterval);
        scanNextCamera();
    }

    function scanNextCamera() {
        if (!window.socket || !socket.connected) {
            scanInterval = setTimeout(scanNextCamera, 1000); // Retry later
            return;
        }

        const cameraUrls = Object.keys(activeVideoFeeds);
        if (cameraUrls.length === 0) {
            scanInterval = setTimeout(scanNextCamera, 1000);
            return;
        }

        // Circular index
        currentCameraIndex = (currentCameraIndex + 1) % cameraUrls.length;
        const cameraUrl = cameraUrls[currentCameraIndex];
        const imgId = activeVideoFeeds[cameraUrl];
        const img = document.getElementById(imgId);

        if (img && img.complete && img.naturalWidth > 0) {
            try {
                // Resize for performance (smaller is faster to send/process)
                // 640x480 is good compromise for barcode readability vs speed
                canvas.width = 640;
                canvas.height = 480;

                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Use lower quality JPEG (0.4) to reduce packet size drastically
                // Barcode detection works fine on noisy images usually
                const imageData = canvas.toDataURL('image/jpeg', 0.4);

                socket.emit('session_barcode_scan', {
                    camera_url: cameraUrl,
                    image: imageData
                });

            } catch (e) {
                console.warn("Skip frame", e);
            }
        }

        // Schedule next scan
        // If we have 4 cameras, 200ms delay = 800ms per cycle per camera (~1.25 FPS per camera)
        // This spreads the load evenly.
        const delay = cameraUrls.length > 2 ? 200 : 300;
        scanInterval = setTimeout(scanNextCamera, delay);
    }

    function emergencyStopAll() {
        if (!confirm('EMERGENCY STOP ALL RECORDINGS?')) return;

        const recordingCameras = cameras.filter(c => c.status === 'recording');

        if (recordingCameras.length === 0) {
            Swal.fire('Info', 'Tidak ada rekaman aktif', 'info');
            return;
        }

        Promise.all(recordingCameras.map(camera =>
            fetch('/api/session/cancel-recording', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ camera_url: camera.camera_url })
            })
        ))
            .then(() => {
                Swal.fire('Berhasil', 'Semua rekaman dihentikan', 'success');
                loadCameras();
            })
            .catch(err => {
                console.error(err);
                Swal.fire('Error', 'Gagal menghentikan rekaman', 'error');
            });
    }

    function cleanupResources() {
        if (scanInterval) clearTimeout(scanInterval);
        if (refreshInterval) clearInterval(refreshInterval);

        // Stop all video feeds by removing src
        Object.values(activeVideoFeeds).forEach(imgId => {
            const img = document.getElementById(imgId);
            if (img) img.src = '';
        });
    }

    // Listen to SocketIO events for audio feedback
    if (window.socket) {
        window.socket.on('session_scan_result', function (data) {
            // Log scan results for debugging
            if (data.action || data.error) {
                console.log("[Scan Result]", data);
            }
        });

        window.socket.on('camera_event', function (data) {
            const { camera_url, event_type } = data;

            if (event_type === 'scan_success') {
                playSound('scan-success');
            } else if (event_type === 'recording_start') {
                playSound('recording-start');
            } else if (event_type === 'recording_stop') {
                playSound('recording-stop');
            } else if (event_type === 'error') {
                playSound('error');
            }

            // Reload cameras to reflect changes immediately
            loadCameras();
        });
    }

    // Cleanup on unload to prevent zombie connections
    window.addEventListener('beforeunload', cleanupResources);

</script>
{% endblock %}